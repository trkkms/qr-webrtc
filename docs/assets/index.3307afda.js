import{a as ae,b as Ae,c as U,u as x,r as l,n as ce,d as R,t as j,l as q,s as S,e as ie,j as a,f as u,g,R as z,h as ke,F as H,i as De,k as K,m as V,G as _e,o as I,P as Be,v as Ee,p as Re}from"./vendor.eec3598d.js";const Fe=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}};Fe();const ee=ae(!1),Q=Ae("as","host",{replaceState:!0,serialize:e=>e,deserialize:e=>e==="host"?"host":"guest"}),ue=U([]),Te=()=>R(ue),k=()=>{const e=x(ue),t=n=>l.exports.useCallback(o=>{console[n==="info"||n==="success"?"log":n](o);const s=new Date,c=ce();return e(i=>{i.unshift({message:o,timestamp:s,level:n,id:c})})},[]);return{info:t("info"),warn:t("warn"),error:t("error"),success:t("success")}},le=U({mic:{volume:1,muted:!1},speaker:{volume:1,muted:!1}}),F=()=>{const e=R(Q),t={main:"#282828",dark:"#000000",light:"#404040"},n={main:"#81d4fa",light:"#b6ffff",dark:"#4ba3c7",text:"#202020"},o={main:"#ffee58",light:"#ffff8b",dark:"#c9bc1f",text:"#202020"};return{color:{background:t,primary:e==="host"?n:o,secondary:e==="host"?o:n,text:"#E8E8E8"}}},T=e=>{let t=new Audio;t.muted=!0,t.srcObject=e,t.addEventListener("canplaythrough",()=>{t=null})},te=(e,t,n,o,r)=>{"ontrack"in e?(o.info("set ontrack event"),e.ontrack=s=>{o.info("ontrack event detected");for(const c of s.streams)o.info("loop on stream"),T(c),t.createMediaStreamSource(c).connect(n),r(n.stream).then(()=>{o.info("update stream")})}):(o.info("set onaddstream event"),e.onaddstream=s=>{o.info("onaddstream event detected"),T(s.stream),t.createMediaStreamSource(s.stream).connect(n),r(n.stream).then(()=>{o.info("update stream")})})},W=()=>{let e=()=>{};const t=new Promise(n=>{e=n});return[n=>e(n),()=>t]},Pe=j({type:q("acceptGuest"),guestId:S,others:ie(j({id:S,name:S}))}),de=j({type:q("offer"),from:S,name:S,to:S,sdp:S}),Ie=j({type:q("acceptHost"),guestId:S,name:S,offers:ie(de)}),fe=j({type:q("answer"),from:S,to:S,sdp:S}),Le=(e,t,n,o,r)=>{const s=new Map,[c,i]=W();return t().then(async d=>{d.onmessage=async y=>{const f=JSON.parse(y.data);if(Pe.is(f)){o.info("accepted by host");const p=f.guestId;c(f.guestId);const w=[];for(const m of f.others){const C=new RTCPeerConnection({iceServers:[]});n(C);const _={peer:C,id:m.id,name:m.name};s.set(m.id,_),await C.setLocalDescription(await C.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}));const v=await new Promise(b=>{C.onicecandidate=A=>{!A.candidate&&C.localDescription&&b(C.localDescription.sdp)}});w.push({type:"offer",from:p,to:m.id,name:e,sdp:v}),C.onconnectionstatechange=()=>{o.info(`connection state change to ${_.id}: ${C.connectionState}`),r()}}const D={type:"acceptHost",guestId:p,offers:w,name:e};d.send(JSON.stringify(D))}if(de.is(f)){o.info(`received offer from: ${f.from}`);const p=await i(),w=new RTCPeerConnection({iceServers:[]});n(w),s.set(f.from,{id:f.from,peer:w,name:f.name}),await w.setRemoteDescription({type:"offer",sdp:f.sdp}),await w.setLocalDescription(await w.createAnswer()),w.onconnectionstatechange=()=>{o.info(`connection state change to ${f.from}: ${w.connectionState}`),r()};const D=await new Promise(C=>{w.onicecandidate=_=>{!_.candidate&&w.localDescription&&C(w.localDescription.sdp)}}),m={type:"answer",from:p,to:f.from,sdp:D};d.send(JSON.stringify(m))}if(fe.is(f)){o.info(`received answer from ${f.from}`);const p=s.get(f.from);if(p==null)return;p.peer.onconnectionstatechange=()=>{o.info(`connection state change to ${f.from}: ${p.peer.connectionState}`),r()},await p.peer.setRemoteDescription({type:"answer",sdp:f.sdp})}}}),{peers:s}},Me=(e,t)=>(n,o)=>{if(Ie.is(o)){t.info(`${o.guestId.slice(0,5)} / accepted by guest`);const r=e.get(o.guestId);if(r==null)return;r.setName(o.name);for(const s of o.offers){t.info(`${s.to.slice(0,5)} / sending offer`);const c=e.get(s.to);c!=null&&c.sendMessage(s)}}if(fe.is(o)){const r=e.get(o.to);if(t.info(`${o.to.slice(0,5)} / sending answer from ${o.from.slice(0,5)}`),r==null)return;r.sendMessage(o)}},$e=async(e,t,n)=>{const o=new Map,r=new AudioContext,s=r.createMediaStreamDestination(),c=await navigator.mediaDevices.getUserMedia({video:!1,audio:{latency:.01,echoCancellation:!0}});T(c),await e(s.stream);const i=Me(o,t);return{createPeer:async()=>{const p=ce(),[w,D]=W(),m=new RTCPeerConnection({iceServers:[]}),C=c.clone();T(C);for(const E of C.getTracks())m.addTrack(E,C);te(m,r,s,t,e),m.onconnectionstatechange=()=>{t.info(`${p.slice(0,5)} / connection state change: ${m.connectionState}`),n()};const _=m.createDataChannel("host-to-guest"),[v,b]=W();_.onopen=()=>{t.info(`${p.slice(0,5)} / data channel established`),v(_)},_.onmessage=E=>{i(p,JSON.parse(E.data))},await m.setLocalDescription(await m.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}));const A=await new Promise(E=>{m.onicecandidate=G=>{!G.candidate&&m.localDescription&&E(m.localDescription.sdp)}}),re={id:p,sdp:A,connect:async E=>{const G=new Promise(Se=>{m.onconnectionstatechange=()=>{t.info(`${p.slice(0,5)} / connection state change: ${m.connectionState}`),n(),m.connectionState==="connected"&&Se()}});return await m.setRemoteDescription({type:"answer",sdp:E}),G},close:()=>{m.close(),o.delete(p),n()},getConnectionState:()=>m.connectionState,sendMessage:async E=>{(await b()).send(JSON.stringify(E))},data:_,setName:w,getName:D};return o.set(p,re),re},getPeer:p=>o.get(p),getPeers:()=>o}},P=U([]),pe=ae({}),me=()=>{const e=x(pe);return l.exports.useCallback(()=>{e(Symbol())},[])},ge=()=>{R(pe)},Ne=({setService:e,setCurrentPeer:t,playAudio:n})=>{const{color:o}=F(),r=x(ee),s=x(P),c=k(),i=me();return a("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}),children:a("button",{type:"button",css:u({padding:"0.5rem 1rem",outline:"none",border:"none",background:o.primary.main,color:o.primary.text,fontSize:"1.5rem",width:"14rem"}),onClick:async()=>{const d=await $e(n,c,i),y=await d.createPeer();e(d),r(!0),t(y),s(f=>{f.push({stage:1,sdp:y.sdp})})},children:"\u63A5\u7D9A\u958B\u59CB"})})},he=({audioRef:e})=>{const t=R(le);return l.exports.useEffect(()=>{e.current&&(e.current.volume=t.speaker.muted?0:t.speaker.volume)},[t.speaker.volume,t.speaker.muted]),a("div",{children:a("audio",{autoPlay:!0,ref:e})})};let h,ye=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});ye.decode();let J=null;function L(){return(J===null||J.buffer!==h.memory.buffer)&&(J=new Uint8Array(h.memory.buffer)),J}function ne(e,t){return ye.decode(L().subarray(e,e+t))}let M=0,Y=new TextEncoder("utf-8");const Oe=typeof Y.encodeInto=="function"?function(e,t){return Y.encodeInto(e,t)}:function(e,t){const n=Y.encode(e);return t.set(n),{read:e.length,written:n.length}};function je(e,t,n){if(n===void 0){const i=Y.encode(e),d=t(i.length);return L().subarray(d,d+i.length).set(i),M=i.length,d}let o=e.length,r=t(o);const s=L();let c=0;for(;c<o;c++){const i=e.charCodeAt(c);if(i>127)break;s[r+c]=i}if(c!==o){c!==0&&(e=e.slice(c)),r=n(r,o,o=c+e.length*3);const i=L().subarray(r+c,r+o);c+=Oe(e,i).written}return M=c,r}let X=null;function $(){return(X===null||X.buffer!==h.memory.buffer)&&(X=new Int32Array(h.memory.buffer)),X}function He(e,t){return L().subarray(e/1,e/1+t)}function We(e){try{const s=h.__wbindgen_add_to_stack_pointer(-16);var t=je(e,h.__wbindgen_malloc,h.__wbindgen_realloc),n=M;h.compress(s,t,n);var o=$()[s/4+0],r=$()[s/4+1];let c;return o!==0&&(c=He(o,r).slice(),h.__wbindgen_free(o,r*1)),c}finally{h.__wbindgen_add_to_stack_pointer(16)}}function we(e,t){const n=t(e.length*1);return L().set(e,n/1),M=e.length,n}function Ge(e,t){try{const c=h.__wbindgen_add_to_stack_pointer(-16);var n=we(e,h.__wbindgen_malloc),o=M;h.into_svg(c,n,o,t);var r=$()[c/4+0],s=$()[c/4+1];let i;return r!==0&&(i=ne(r,s).slice(),h.__wbindgen_free(r,s*1)),i}finally{h.__wbindgen_add_to_stack_pointer(16)}}function be(e){try{const s=h.__wbindgen_add_to_stack_pointer(-16);var t=we(e,h.__wbindgen_malloc),n=M;h.inflate(s,t,n);var o=$()[s/4+0],r=$()[s/4+1];let c;return o!==0&&(c=ne(o,r).slice(),h.__wbindgen_free(o,r*1)),c}finally{h.__wbindgen_add_to_stack_pointer(16)}}async function Ue(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}async function ve(e){typeof e=="undefined"&&(e=new URL("/qr-webrtc/assets/wasm_bg.8832fa6e.wasm",self.location));const t={};t.wbg={},t.wbg.__wbg_alert_f5393de24ed74e50=function(r,s){alert(ne(r,s))},(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await Ue(await e,t);return h=n.exports,ve.__wbindgen_wasm_module=o,h}const Ce=({src:e,cacheKey:t})=>{const n=l.exports.useRef({}),o=k(),r=l.exports.useMemo(()=>{const s=n.current[t];if(s)return s;const c=Ge(e,300);return c===void 0?(o.error("QR Code creation failed for some reason."),""):(n.current[t]=c,c)},[e,t]);return l.exports.useEffect(()=>{console.log(`${t} generate:`),console.log(e)},[e,t]),a("div",{dangerouslySetInnerHTML:{__html:r}})},N=({backTitle:e,nextTitle:t,onBack:n,onNext:o})=>{const{color:r}=F();return g("ul",{css:u({display:"grid",gridTemplateColumns:"50% 50%",width:"100%",padding:"2rem",gap:"1rem",maxWidth:"400px"}),children:[e!=null&&a("li",{children:a("button",{type:"button",css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:r.primary.main}),onClick:n,children:e})}),t&&a("li",{css:u({display:"flex",justifyContent:"center",alignItems:"center"}),children:a("button",{type:"button",css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:r.primary.main}),onClick:o,children:t})})]})},B=({title:e,children:t})=>g("section",{css:u({display:"flex",flexWrap:"wrap",justifyContent:"center",width:"100%",padding:"1rem"}),children:[a("h2",{css:u({width:"100%",marginBottom:"1rem",fontSize:"larger"}),children:e}),t]}),xe=(e,t,n,o,r)=>{const s=l.exports.useMemo(()=>{const c=We(e);if(c==null){n.error("Failed to compress sdp.");return}return new Uint8Array(c)},o);return l.exports.useMemo(()=>s==null?void 0:t===1?s.subarray(0,s.length/2):s.subarray(s.length/2),r)},qe=z.memo(function({stage:t}){const n=x(P),[o,r]=l.exports.useState(1),s=k(),c=l.exports.useCallback(()=>{o===2?r(1):n(()=>[{stage:5}])},[o]),i=l.exports.useCallback(()=>{o===1?r(2):n(f=>{f.push({stage:2})})},[o]),d=o===1?"1.\u30AA\u30D5\u30A1\u30FC(\u524D\u534A)":"1.\u30AA\u30D5\u30A1\u30FC(\u5F8C\u534A)",y=xe(t.sdp,o,s,[t],[t,o]);return g(B,{title:d,children:[y&&a("div",{css:u({display:"flex",justifyContent:"center",width:"100%",marginBottom:"1rem"}),children:a(Ce,{src:y,cacheKey:`host-offer-${o}`})}),a("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:a("span",{children:"\u63A5\u7D9A\u3059\u308B\u30B2\u30B9\u30C8\u306B\u63D0\u793A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"})}),o===2&&a("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:"\u300C\u6B21\u3078\u300D\u3092\u62BC\u3059\u3068\u30AB\u30E1\u30E9\u304C\u8D77\u52D5\u3057\u307E\u3059\u3002"}),a(N,{backTitle:o===2?"\u623B\u308B":"\u30B2\u30B9\u30C8\u4E00\u89A7",nextTitle:"\u6B21\u3078",onBack:c,onNext:i})]})}),Z=({onResult:e})=>{const t=l.exports.useRef(null),n=k();return l.exports.useEffect(()=>{const r=(async()=>{const s=document.createElement("video"),c=t.current;if(c==null){n.error("Failed to get canvas element.");return}const i=c.getContext("2d");if(i==null){n.error("Failed to get canvas context");return}const d=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}});return s.srcObject=d,await s.play(),requestAnimationFrame(function f(){const p=t.current;if(p==null||s.readyState!==s.HAVE_ENOUGH_DATA)return;p.width=s.videoWidth,p.height=s.videoHeight,i.drawImage(s,0,0,p.width,p.height);const w=i.getImageData(0,0,p.width,p.height),D=ke(w.data,w.width,w.height,{inversionAttempts:"dontInvert"});if(!D){requestAnimationFrame(f);return}e(D),d.getTracks().forEach(m=>{m.readyState==="live"&&m.stop()})}),d})().catch(s=>{n.error(`Cannot get video stream: ${String(s)}`)});return()=>{r.then(s=>{s&&s.getTracks().forEach(c=>{c.readyState==="live"&&c.stop()})})}},[]),a("div",{css:u({width:"100%",display:"flex",alignItems:"center",justifyContent:"center"}),children:a("canvas",{css:u({width:"80%"}),ref:t})})},ze=()=>{const[e,t]=l.exports.useState(void 0),n=x(P),o=l.exports.useCallback(c=>{console.log("answer1 received:"),console.log(c.binaryData),t(c.binaryData)},[]),r=l.exports.useCallback(()=>{n(c=>{c.pop()})},[]),s=l.exports.useCallback(()=>{e!=null&&n(c=>{c.push({stage:3,halfAnswer:e})})},[e]);return g(B,{title:"2.\u30A2\u30F3\u30B5\u30FC\u53D7\u4FE1(\u524D\u534A)",children:[e==null&&a(Z,{onResult:o}),a(N,{backTitle:"\u623B\u308B",onBack:r,nextTitle:e!=null?"\u6B21\u3078":void 0,onNext:s})]})},Ve=({stage:e})=>{const[t,n]=l.exports.useState(void 0),o=x(P),r=k(),s=l.exports.useCallback(i=>{console.log("answer2 received:"),console.log(i.binaryData);const d=be(new Uint8Array([...e.halfAnswer.slice(5),...i.binaryData.slice(5)]));d!=null?(n(d),o(y=>{y.push({stage:4,sdp:d})})):r.error("Decoding SDP Failed")},[]),c=l.exports.useCallback(()=>{o(i=>{n(void 0),i.pop()})},[]);return g(B,{title:"3.\u30A2\u30F3\u30B5\u30FC\u53D7\u4FE1(\u5F8C\u534A)",children:[t==null&&a(Z,{onResult:s}),a(N,{backTitle:"\u623B\u308B",onBack:c})]})},Qe=({stage:e,peer:t,service:n})=>{const o=k(),r=x(P);return l.exports.useEffect(()=>{(async()=>{await t.connect(e.sdp);const c={type:"acceptGuest",guestId:t.id,others:await Promise.all(Array.from(n.getPeers().values()).filter(i=>i.id!==t.id).map(async i=>({id:i.id,name:await i.getName()})))};await t.sendMessage(c),r(()=>[{stage:5}])})().catch(c=>{o.error(`Failed to receive answer: ${String(c)}`)})},[]),a(B,{title:"4. \u63A5\u7D9A\u4E2D",children:a("p",{children:"\u63A5\u7D9A\u4E2D\u3067\u3059..."})})},Je=({textP:e})=>{const[t,n]=l.exports.useState(void 0);return l.exports.useEffect(()=>{e.then(o=>{n(o)})},[]),a(H,{children:t!=null?t:""})},Ye=({service:e,setCurrentPeer:t})=>{const n=e.getPeers(),o=x(P);ge();const{color:r}=F();return l.exports.useEffect(()=>{for(const s of n.values())s.getConnectionState()!=="connected"&&s.close()},[]),a(B,{title:"\u30B2\u30B9\u30C8\u4E00\u89A7",children:g("div",{children:[n.size===0&&a("p",{css:u({marginBottom:"5rem"}),children:"\u307E\u3060\u63A5\u7D9A\u306F\u3042\u308A\u307E\u305B\u3093\u3002"}),a("div",{css:u({display:"flex",justifyContent:"center"}),children:a("button",{type:"button",css:u({border:"none",outline:"none",padding:"0.5rem 1rem",background:r.primary.main}),onClick:async()=>{const s=await e.createPeer();t(s),o(()=>[{stage:1,sdp:s.sdp}])},children:"\u65B0\u898F\u63A5\u7D9A"})}),n.size>0&&a("ol",{css:u({display:"flex",flexWrap:"wrap",padding:"1rem",width:"100%"}),children:[...n.values()].map(s=>g("li",{css:u({display:"flex",justifyContent:"space-between",width:"100%"}),children:[a("span",{css:u({marginRight:"1rem"}),children:s.id.slice(0,6)}),a("span",{css:u({marginRight:"1rem"}),children:a(Je,{textP:s.getName()})}),a("span",{children:s.getConnectionState()}),a("button",{type:"button",css:u({border:"none",outline:"none",width:"2rem",background:r.secondary.dark}),onClick:()=>{s.close()},children:"\xD7"})]},s.id))})]})})},Xe=({service:e,peer:t,setCurrentPeer:n})=>{const o=R(P),r=o[o.length-1];return r==null?null:r.stage===1?a(qe,{stage:r}):r.stage===2?a(ze,{}):r.stage===3?a(Ve,{stage:r}):r.stage===4?a(Qe,{service:e,stage:r,peer:t}):r.stage===5?a(Ye,{service:e,setCurrentPeer:n}):a(H,{})},Ze=()=>{const[e,t]=l.exports.useState(),[n,o]=l.exports.useState(),r=k(),s=l.exports.useRef(null),c=l.exports.useCallback(async i=>{if(s.current==null){r.warn("ignore playAudio() since no audio element found.");return}s.current.srcObject=i,await s.current.play(),s.current.volume=1},[]);return g("main",{css:u({width:"100%",height:"100%",maxWidth:1200}),children:[!e&&a(Ne,{setService:t,setCurrentPeer:o,playAudio:c}),e&&n!=null&&a(Xe,{service:e,peer:n,setCurrentPeer:o}),a(he,{audioRef:s})]})},Ke=async(e,t,n,o)=>{const r=new AudioContext,s=r.createMediaStreamDestination(),c=await navigator.mediaDevices.getUserMedia({video:!1,audio:{latency:.01,echoCancellation:!0}});T(c),await e(s.stream);const[i,d]=W(),[y,f]=W(),p=async()=>{const v=new RTCPeerConnection({iceServers:[]}),b=c.clone();T(b);for(const A of b.getTracks())v.addTrack(A,b);return te(v,r,s,t,e),v.onconnectionstatechange=()=>{t.info(`host connection state change: ${v.connectionState}`)},v.ondatachannel=A=>{t.info("data channel established"),i(A.channel)},y(v),v},w=async v=>{const b=await f();await b.setRemoteDescription({type:"offer",sdp:v});const A=await b.createAnswer();return await b.setLocalDescription(A),new Promise(oe=>{b.onicecandidate=se=>{!se.candidate&&b.localDescription!=null&&oe(b.localDescription.sdp)}})},D=async v=>{const b=await f();b.onconnectionstatechange=()=>{b.connectionState==="connected"&&(t.info("connected to host"),v())}},C=Le(n,d,v=>{const b=c.clone();T(b);for(const A of b.getTracks())v.addTrack(A,b);te(v,r,s,t,e)},t,o);return{createAnswer:w,setOnConnect:D,close:async()=>(await f()).close(),signalService:C,createHostPeer:p}},et=De("guestName","\u306A\u306A\u3057\u3055\u3093"),O=U([]),tt=({setService:e,playAudio:t})=>{const n=k(),{color:o}=F(),r=x(ee),[s,c]=K(et),i=x(O),d=me();return a("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}),children:g("div",{css:u({width:"100%",padding:"2rem"}),children:[a("div",{css:u({display:"flex",width:"100%",justifyContent:"center",marginBottom:"3rem"}),children:a("input",{type:"text",css:u({outline:"none",border:"none",fontSize:"1rem",padding:"0.25rem 0.5rem",height:"3rem",width:"14rem"}),onChange:y=>{c(y.target.value)},value:s})}),a("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%"}),children:a("button",{type:"button",css:u({padding:"0.5rem 1rem",outline:"none",border:"none",background:o.primary.main,color:o.primary.text,fontSize:"1.5rem",width:"14rem"}),onClick:async()=>{const y=await Ke(t,n,s,d);e(y),r(!0),i(f=>{f.push({stage:1})})},children:"\u63A5\u7D9A\u958B\u59CB"})})]})})},nt=()=>{const[e,t]=l.exports.useState(void 0),n=x(O),o=l.exports.useCallback(s=>{console.log("offer1 received:"),console.log(s.binaryData),t(s.binaryData)},[]),r=l.exports.useCallback(()=>{e!=null&&n(s=>{s.push({stage:2,halfOffer:e})})},[e]);return g(B,{title:"1.\u30AA\u30D5\u30A1\u30FC\u53D7\u4FE1(\u524D\u534A)",children:[e==null&&a(Z,{onResult:o}),e&&a(N,{nextTitle:"\u6B21\u3078",onNext:r})]})},ot=({stage:e,service:t})=>{const[n,o]=l.exports.useState(void 0),r=x(O),s=l.exports.useCallback(async i=>{console.log("offer2 received:"),console.log(i.binaryData);const d=be(new Uint8Array([...e.halfOffer.slice(5),...i.binaryData.slice(5)]));if(console.log(d),o(d),d!=null){o(d),await t.createHostPeer();const y=await t.createAnswer(d);r(f=>{f.push({stage:3,sdp:y})})}},[]),c=l.exports.useCallback(()=>{o(void 0),r(i=>{i.pop()})},[]);return g(B,{title:"2.\u30AA\u30D5\u30A1\u30FC\u53D7\u4FE1(\u5F8C\u534A)",children:[n==null&&a(Z,{onResult:s}),a(N,{backTitle:"\u623B\u308B",onBack:c})]})},st=({stage:e,service:t})=>{const n=x(O),[o,r]=l.exports.useState(1),s=k(),c=o===1?"3.\u30A2\u30F3\u30B5\u30FC(\u524D\u534A)":"3.\u30A2\u30F3\u30B5\u30FC(\u5F8C\u534A)",i=xe(e.sdp,o,s,[e],[e,o]),d=l.exports.useCallback(()=>{o===1&&r(2)},[]),y=l.exports.useCallback(()=>{if(o===2){r(1);return}n(f=>{f.pop(),f.pop()})},[]);return l.exports.useLayoutEffect(()=>{t.setOnConnect(()=>{n(f=>{f.push({stage:4})})})},[]),g(B,{title:c,children:[i&&a("div",{css:u({display:"flex",justifyContent:"center",width:"100%",marginBottom:"1rem"}),children:a(Ce,{src:i,cacheKey:`guest-answer-${o}`})}),a("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:a("span",{children:`\u30DB\u30B9\u30C8\u306BQR\u30B3\u30FC\u30C9\u3092${o===2?"\u3082\u3046\u4E00\u5EA6":""}\u63D0\u793A\u3057\u3066\u304F\u3060\u3055\u3044\u3002`})}),a(N,{backTitle:"\u623B\u308B",nextTitle:o===1?"\u6B21\u3078":void 0,onNext:d,onBack:y})]})},rt=()=>{const e=x(O);return l.exports.useEffect(()=>{e(()=>[{stage:5}])},[]),a(B,{title:"4. \u63A5\u7D9A\u4E2D",children:a("p",{children:"\u63A5\u7D9A\u4E2D\u3067\u3059..."})})},at=({service:e})=>{const t=e.signalService.peers;return ge(),a(B,{title:"\u63A5\u7D9A\u4E00\u89A7",children:g("ol",{children:[a("li",{children:"\u30DB\u30B9\u30C8"}),Array.from(t.values()).map(n=>a("li",{children:`${n.id.slice(0,6)} ${n.name}`},n.id))]})})},ct=({service:e})=>{const t=R(O),n=t[t.length-1];return n==null?null:n.stage===1?a(nt,{}):n.stage===2?a(ot,{stage:n,service:e}):n.stage===3?a(st,{stage:n,service:e}):n.stage===4?a(rt,{}):n.stage===5?a(at,{service:e}):a(H,{})},it=()=>{const e=l.exports.useRef(null),t=k(),[n,o]=l.exports.useState(void 0),r=l.exports.useCallback(async s=>{if(e.current==null){t.warn("ignore playAudio() since no audio element found.");return}e.current.srcObject=s,await e.current.play(),e.current.volume=1},[]);return g("main",{css:u({width:"100%",height:"100%",maxWidth:1200}),children:[n==null&&a(tt,{setService:o,playAudio:r}),n&&a(ct,{service:n}),a(he,{audioRef:e})]})},ut=()=>{const[e,t]=K(Q),n=R(ee),o=k(),{color:r}=F(),s=e==="host"?"\u30DB\u30B9\u30C8":"\u30B2\u30B9\u30C8",c=e==="host"?"\u30B2\u30B9\u30C8":"\u30DB\u30B9\u30C8";return a("button",{className:V({started:n}),css:u({width:"9rem",border:"none",outline:"none",padding:"0.125rem 0.5rem",background:`linear-gradient(135deg, ${r.primary.main} 50%, ${r.secondary.main} 50%)`,color:r.primary.text,"&.started":{background:r.background.dark,color:r.text}}),type:"button",onClick:()=>{if(n){o.warn("\u30BB\u30C3\u30B7\u30E7\u30F3\u304C\u958B\u59CB\u3055\u308C\u3066\u3044\u307E\u3059\u3002\u30E2\u30FC\u30C9\u3092\u5909\u66F4\u3067\u304D\u307E\u305B\u3093\u3002");return}t(i=>i==="host"?"guest":"host")},disabled:n,children:n?a("span",{children:s}):g(H,{children:[a("span",{css:u({fontWeight:"bolder"}),children:`[${s}]`})," \u21D2 ",a("span",{children:c})]})})},lt=()=>{const{color:e}=F(),[t,n]=l.exports.useState("");return l.exports.useEffect(()=>{const o=Array.from(document.getElementsByTagName("script"));for(const r of o){const s=/index\.([^.]+)\.js$/.exec(r.src);if(s){n(s[1]);break}}},[]),g("header",{css:u({display:"flex",justifyContent:"space-between",alignItems:"center",height:"100%",paddingLeft:"0.5rem",paddingRight:"1rem",background:e.background.light}),children:[g("span",{children:["QR WebRTC",t?` -${t}`:""]}),a(ut,{})]})},dt=z.memo(function({item:t}){const{timestamp:n,level:o,message:r}=t,c=`${[n.getHours(),n.getMinutes(),n.getSeconds()].map(i=>i.toString(10).padStart(2,"0")).join(":")} [${o.toUpperCase()}] ${r}`;return a("li",{className:o,css:u({fontFamily:"monospace","&.info":{color:"#bdbdbd"},"&.warn":{color:"#ffa726"},"&.error":{color:"#ef5350"},"&.success":{color:"#29b6f6"}}),children:c})}),ft=z.memo(function({items:t}){return a("ul",{css:u({height:"100%",paddingLeft:"0.5rem"}),children:t.map(n=>a(dt,{item:n},n.id))})}),pt=()=>{const[e,t]=K(le);return a("div",{css:u({display:"flex",alignItems:"center",justifyContent:"space-around",width:"100%"}),children:g("div",{css:u({display:"block"}),children:[a("input",{type:"range",step:.01,min:0,max:1,value:e.speaker.volume,onChange:n=>{t(o=>{o.speaker.volume=Number(n.currentTarget.value)})}}),a("button",{css:u({outline:"none",border:"none",background:"transparent"}),type:"button",onClick:()=>{t(n=>{n.speaker.muted=!n.speaker.muted})},children:e.speaker.muted?"\u{1F507}":"\u{1F50A}"})]})})},mt=()=>{const[e,t]=l.exports.useState(!1),{color:n}=F(),o=Te(),r=o.length>0&&o[o.length-1].level==="error";return l.exports.useEffect(()=>{r&&t(!0)},[r]),g("footer",{className:V({open:e}),css:u({display:"grid",height:"3.5rem",gridTemplateRows:"2rem 1.5rem 1fr",overflow:"hidden",transition:"all 0.5s","&.open":{height:"12rem"},background:n.background.dark,color:n.text}),children:[a("div",{css:u({display:"flex",alignItems:"center",borderBottom:`1px solid ${n.primary.dark}`,width:"100%"}),children:a(pt,{})}),g("button",{type:"button",className:V({error:r}),css:u({display:"flex",justifyContent:"right",alignItems:"center",width:"100%",height:"100%",paddingRight:"1rem",border:"none",outline:"none",background:n.background.dark,color:n.text,"&.error":{background:"#b61827"}}),onClick:()=>t(s=>!s),children:[a("span",{css:u({marginRight:"0.75rem"}),children:"\u30ED\u30B0"}),a("span",{className:V({open:e}),css:u({display:"inline-block",height:"0.75rem",width:"0.75rem",borderLeft:"0.375rem solid transparent",borderBottom:"0.75rem solid white",borderRight:"0.375rem solid transparent",transition:"all 0.5s","&.open":{transform:"rotate(-180deg)"}})})]}),a("div",{css:u({height:"100%",overflowY:"scroll",borderTop:`1px solid ${n.primary.dark}`,scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"}}),children:a(ft,{items:o})})]})},gt=({children:e})=>{const{color:t}=F();return g(H,{children:[g("div",{css:u({display:"grid",width:"100%",height:"100%",gridTemplateRows:"2.5rem 1fr auto"}),children:[a("div",{css:u({height:"100%"}),children:a(lt,{})}),a("div",{css:u({height:"100%",display:"flex",justifyContent:"center"}),children:e}),a("div",{css:u({height:"100%"}),children:a(mt,{})})]}),a(_e,{styles:u({"html, body, #root":{height:"100%"},"*":{boxSizing:"border-box",margin:0,padding:0},"ul, ol":{margin:0,padding:0,listStyleType:"none"},body:{background:t.background.main,color:t.text,margin:0,padding:0}})})]})},ht=()=>{const e=R(Q),t=x(Q);return l.exports.useLayoutEffect(()=>{ve().catch(r=>{console.error(r)});const o=new URLSearchParams(window.location.hash.substring(1)).get("as")||"host";t(o==="host"?"host":"guest")},[]),I(gt,{children:e==="host"?I(Ze,{}):I(it,{})})},yt=({children:e})=>a(Be,{children:e});function wt(e={}){const{immediate:t=!1,onNeedRefresh:n,onOfflineReady:o,onRegistered:r,onRegisterError:s}=e;let c;const i=async(d=!0)=>{};return"serviceWorker"in navigator&&(c=new Ee("/qr-webrtc/sw.js",{scope:"/qr-webrtc/"}),c.addEventListener("activated",d=>{d.isUpdate?window.location.reload():o==null||o()}),c.register({immediate:t}).then(d=>{r==null||r(d)}).catch(d=>{s==null||s(d)})),i}wt({onNeedRefresh(){}});Re.render(I(z.StrictMode,{children:I(yt,{children:I(ht,{})})}),document.getElementById("root"));
