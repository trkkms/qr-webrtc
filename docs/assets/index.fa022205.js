import{a as ie,b as Ne,c as Y,u as k,r as d,n as he,d as P,t as Q,l as K,s as x,e as ye,j as r,f as u,g,R as X,h as Oe,i as Z,F as N,k as We,m as ee,G as je,o as O,P as He,v as Ue,p as Ge,q as Ve}from"./vendor.9d411574.js";const qe=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerpolicy&&(c.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?c.credentials="include":s.crossorigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function t(s){if(s.ep)return;s.ep=!0;const c=o(s);fetch(s.href,c)}};qe();const ue=ie(!1),te=Ne("as","host",{replaceState:!0,serialize:e=>e,deserialize:e=>e==="host"?"host":"guest"}),be=Y([]),ze=()=>P(be),A=()=>{const e=k(be),n=o=>d.exports.useCallback(t=>{console[o==="info"||o==="success"?"log":o](t);const c=new Date,a=he();return e(i=>{i.unshift({message:t,timestamp:c,level:o,id:a})})},[]);return{info:n("info"),warn:n("warn"),error:n("error"),success:n("success")}},ne=Y({mic:{volume:1,muted:!1},speaker:{volume:1,muted:!1,unlockLimit:!1}});ie(void 0);const _=()=>{const e=P(te),n={main:"#282828",dark:"#000000",light:"#404040"},o={main:"#81d4fa",light:"#b6ffff",dark:"#4ba3c7",text:"#202020"},t={main:"#ffee58",light:"#ffff8b",dark:"#c9bc1f",text:"#202020"};return{color:{background:n,primary:e==="host"?o:t,secondary:e==="host"?t:o,alert:{main:"#ff8a65",light:"#ffbb93",dark:"#c75b39",text:"#202020"},text:"#E8E8E8"}}},E=e=>{let n=new Audio;n.muted=!0,n.srcObject=e,n.addEventListener("canplaythrough",()=>{n=null})},de=(e,n,o,t,s,c)=>{"ontrack"in e?(t.info("set ontrack event"),e.ontrack=a=>{t.info("ontrack event detected");for(const i of a.streams)t.info("loop on stream"),E(i),n.createMediaStreamSource(i).connect(o),s(o.stream).then(()=>{t.info("update stream")})}):(t.info("set onaddstream event"),e.onaddstream=a=>{t.info("onaddstream event detected"),E(a.stream),n.createMediaStreamSource(a.stream).connect(o),s(o.stream).then(()=>{t.info("update stream")})})},we=(e,n)=>{const o=e.createGain(),t=e.createMediaStreamDestination();return e.createMediaStreamSource(n).connect(o),o.connect(t),[a=>{o.gain.setValueAtTime(a,e.currentTime)},t.stream]},Qe=async()=>await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}}),W=()=>{let e=()=>{};const n=new Promise(o=>{e=o});return[o=>e(o),()=>n]},Je=Q({type:K("acceptGuest"),guestId:x,others:ye(Q({id:x,name:x}))}),ve=Q({type:K("offer"),from:x,name:x,to:x,sdp:x}),Ye=Q({type:K("acceptHost"),guestId:x,name:x,offers:ye(ve)}),Ce=Q({type:K("answer"),from:x,to:x,sdp:x}),Ke=(e,n,o,t,s)=>{const c=new Map,[a,i]=W();return n().then(async m=>{m.onmessage=async l=>{const f=JSON.parse(l.data);if(Je.is(f)){t.info("accepted by host");const v=f.guestId;a(f.guestId);const w=[];for(const C of f.others){const S=new RTCPeerConnection({iceServers:[]});o(S);const F={peer:S,id:C.id,name:C.name};c.set(C.id,F),await S.setLocalDescription(await S.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}));const M=await new Promise(ae=>{S.onicecandidate=p=>{!p.candidate&&S.localDescription&&ae(S.localDescription.sdp)}});w.push({type:"offer",from:v,to:C.id,name:e,sdp:M}),S.onconnectionstatechange=()=>{t.info(`connection state change to ${F.id}: ${S.connectionState}`),s()}}const B={type:"acceptHost",guestId:v,offers:w,name:e};m.send(JSON.stringify(B))}if(ve.is(f)){t.info(`received offer from: ${f.from}`);const v=await i(),w=new RTCPeerConnection({iceServers:[]});o(w),c.set(f.from,{id:f.from,peer:w,name:f.name}),await w.setRemoteDescription({type:"offer",sdp:f.sdp}),await w.setLocalDescription(await w.createAnswer()),w.onconnectionstatechange=()=>{t.info(`connection state change to ${f.from}: ${w.connectionState}`),s()};const B=await new Promise(S=>{w.onicecandidate=F=>{!F.candidate&&w.localDescription&&S(w.localDescription.sdp)}}),C={type:"answer",from:v,to:f.from,sdp:B};m.send(JSON.stringify(C))}if(Ce.is(f)){t.info(`received answer from ${f.from}`);const v=c.get(f.from);if(v==null)return;v.peer.onconnectionstatechange=()=>{t.info(`connection state change to ${f.from}: ${v.peer.connectionState}`),s()},await v.peer.setRemoteDescription({type:"answer",sdp:f.sdp})}}}),{peers:c}},Xe=(e,n)=>(o,t)=>{if(Ye.is(t)){n.info(`${t.guestId.slice(0,5)} / accepted by guest`);const s=e.get(t.guestId);if(s==null)return;s.setName(t.name);for(const c of t.offers){n.info(`${c.to.slice(0,5)} / sending offer`);const a=e.get(c.to);a!=null&&a.sendMessage(c)}}if(Ce.is(t)){const s=e.get(t.to);if(n.info(`${t.to.slice(0,5)} / sending answer from ${t.from.slice(0,5)}`),s==null)return;s.sendMessage(t)}},Ze=async(e,n,o)=>{const t=new Map,s=new AudioContext,c=s.createMediaStreamDestination(),a=s.createMediaStreamDestination(),i=await navigator.mediaDevices.getUserMedia({video:!1,audio:{latency:.01,echoCancellation:!0}}),[m,l]=W();E(i);const f=i.clone();E(f),s.createMediaStreamSource(f).connect(a);const[w,B]=we(s,i);await e(c.stream);const C=Xe(t,n);return{createPeer:async()=>{const p=he(),[y,D]=W(),h=new RTCPeerConnection({iceServers:[]}),L=B.clone();E(L);for(const T of L.getTracks())h.addTrack(T,L);de(h,s,c,n,e),h.onconnectionstatechange=()=>{n.info(`${p.slice(0,5)} / connection state change: ${h.connectionState}`),o()};const q=h.createDataChannel("host-to-guest"),[fe,me]=W();q.onopen=()=>{n.info(`${p.slice(0,5)} / data channel established`),fe(q)},q.onmessage=T=>{C(p,JSON.parse(T.data))},await h.setLocalDescription(await h.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}));const pe=await new Promise(T=>{h.onicecandidate=J=>{!J.candidate&&h.localDescription&&T(h.localDescription.sdp)}}),$={id:p,sdp:pe,connect:async T=>{const J=new Promise($e=>{h.onconnectionstatechange=()=>{n.info(`${p.slice(0,5)} / connection state change: ${h.connectionState}`),o(),h.connectionState==="connected"&&$e()}});return await h.setRemoteDescription({type:"answer",sdp:T}),J},close:()=>{h.close(),t.delete(p),o()},getConnectionState:()=>h.connectionState,sendMessage:async T=>{(await me()).send(JSON.stringify(T))},data:q,setName:y,getName:D};return t.set(p,$),$},getPeer:p=>t.get(p),getPeers:()=>t,changeVolume:w,startRecording:()=>{const p=a.stream.clone();E(p);const y=s.createMediaStreamSource(p);y.connect(a);const D=a.stream;m(y);const h=new MediaRecorder(D,{mimeType:"audio/mpeg",audioBitsPerSecond:64e3}),L=[];return h.ondataavailable=z=>{L.push(z.data)},h.start(1e3),{stopRecording:()=>{h.pause()},save:()=>{const z=new Blob(L,{type:"audio/mpeg"}),ge=URL.createObjectURL(z),$=document.createElement("a");$.download="recorded.mp3",$.href=ge,$.click()},clear:async()=>{(h.state==="paused"||h.state==="recording")&&(h.stop(),(await l()).disconnect(a))},getRecordState:()=>h.state,pause:()=>{h.pause()},resume:()=>{h.resume()}}}}},I=Y([]),Se=ie({}),ke=()=>{const e=k(Se);return d.exports.useCallback(()=>{e(Symbol())},[])},Ae=()=>{P(Se)},et=({setService:e,setCurrentPeer:n,playAudio:o})=>{const{color:t}=_(),s=k(ue),c=k(I),a=A(),i=ke();return r("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}),children:r("button",{type:"button",css:u({padding:"0.5rem 1rem",outline:"none",border:"none",background:t.primary.main,color:t.primary.text,fontSize:"1.5rem",width:"14rem"}),onClick:async()=>{const m=await Ze(o,a,i),l=await m.createPeer();e(m),s(!0),n(l),c(f=>{console.log("offer sdp:",l.sdp),f.push({stage:1,sdp:l.sdp})})},children:"\u63A5\u7D9A\u958B\u59CB"})})},xe=({audioRef:e})=>{const n=P(ne);return d.exports.useEffect(()=>{e.current&&(e.current.volume=n.speaker.muted?0:n.speaker.volume)},[n.speaker.volume,n.speaker.muted]),r("div",{children:r("audio",{autoPlay:!0,ref:e})})};let b,De=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});De.decode();let oe=null;function j(){return(oe===null||oe.buffer!==b.memory.buffer)&&(oe=new Uint8Array(b.memory.buffer)),oe}function le(e,n){return De.decode(j().subarray(e,e+n))}let H=0,se=new TextEncoder("utf-8");const tt=typeof se.encodeInto=="function"?function(e,n){return se.encodeInto(e,n)}:function(e,n){const o=se.encode(e);return n.set(o),{read:e.length,written:o.length}};function nt(e,n,o){if(o===void 0){const i=se.encode(e),m=n(i.length);return j().subarray(m,m+i.length).set(i),H=i.length,m}let t=e.length,s=n(t);const c=j();let a=0;for(;a<t;a++){const i=e.charCodeAt(a);if(i>127)break;c[s+a]=i}if(a!==t){a!==0&&(e=e.slice(a)),s=o(s,t,t=a+e.length*3);const i=j().subarray(s+a,s+t);a+=tt(e,i).written}return H=a,s}let re=null;function U(){return(re===null||re.buffer!==b.memory.buffer)&&(re=new Int32Array(b.memory.buffer)),re}function ot(e,n){return j().subarray(e/1,e/1+n)}function st(e){try{const c=b.__wbindgen_add_to_stack_pointer(-16);var n=nt(e,b.__wbindgen_malloc,b.__wbindgen_realloc),o=H;b.compress(c,n,o);var t=U()[c/4+0],s=U()[c/4+1];let a;return t!==0&&(a=ot(t,s).slice(),b.__wbindgen_free(t,s*1)),a}finally{b.__wbindgen_add_to_stack_pointer(16)}}function Be(e,n){const o=n(e.length*1);return j().set(e,o/1),H=e.length,o}function rt(e,n){try{const a=b.__wbindgen_add_to_stack_pointer(-16);var o=Be(e,b.__wbindgen_malloc),t=H;b.into_svg(a,o,t,n);var s=U()[a/4+0],c=U()[a/4+1];let i;return s!==0&&(i=le(s,c).slice(),b.__wbindgen_free(s,c*1)),i}finally{b.__wbindgen_add_to_stack_pointer(16)}}function _e(e){try{const c=b.__wbindgen_add_to_stack_pointer(-16);var n=Be(e,b.__wbindgen_malloc),o=H;b.inflate(c,n,o);var t=U()[c/4+0],s=U()[c/4+1];let a;return t!==0&&(a=le(t,s).slice(),b.__wbindgen_free(t,s*1)),a}finally{b.__wbindgen_add_to_stack_pointer(16)}}async function ct(e,n){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,n)}catch(t){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t);else throw t}const o=await e.arrayBuffer();return await WebAssembly.instantiate(o,n)}else{const o=await WebAssembly.instantiate(e,n);return o instanceof WebAssembly.Instance?{instance:o,module:e}:o}}async function Ee(e){typeof e=="undefined"&&(e=new URL("/qr-webrtc-dev/assets/wasm_bg.5810598b.wasm",self.location));const n={};n.wbg={},n.wbg.__wbg_alert_f5393de24ed74e50=function(s,c){alert(le(s,c))},(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:o,module:t}=await ct(await e,n);return b=o.exports,Ee.__wbindgen_wasm_module=t,b}const Re=({src:e,cacheKey:n})=>{const o=d.exports.useRef({}),t=A(),s=d.exports.useMemo(()=>{const c=o.current[n];if(c)return c;const a=rt(e,300);return a===void 0?(t.error("QR Code creation failed for some reason."),""):(o.current[n]=a,a)},[e,n]);return d.exports.useEffect(()=>{console.log(`${n} generate:`),console.log(e)},[e,n]),r("div",{dangerouslySetInnerHTML:{__html:s}})},G=({backTitle:e,nextTitle:n,onBack:o,onNext:t})=>{const{color:s}=_();return g("ul",{css:u({display:"grid",gridTemplateColumns:"50% 50%",width:"100%",padding:"2rem",gap:"1rem",maxWidth:"400px"}),children:[e!=null&&r("li",{children:r("button",{type:"button",css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:s.primary.main}),onClick:o,children:e})}),n&&r("li",{css:u({display:"flex",justifyContent:"center",alignItems:"center"}),children:r("button",{type:"button",css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:s.primary.main}),onClick:t,children:n})})]})},R=({title:e,children:n})=>g("section",{css:u({display:"flex",flexWrap:"wrap",justifyContent:"center",width:"100%",padding:"1rem"}),children:[r("h2",{css:u({width:"100%",marginBottom:"1rem",fontSize:"larger"}),children:e}),n]}),Fe=(e,n,o,t,s)=>{const c=d.exports.useMemo(()=>{const a=st(e);if(a==null){o.error("Failed to compress sdp.");return}return new Uint8Array(a)},t);return d.exports.useMemo(()=>(console.log("original bytes",new Blob([e]).size),console.log("compressed",c),c==null?void 0:n===1?c.subarray(0,c.length/2):c.subarray(c.length/2)),s)},at=X.memo(function({stage:n}){const o=k(I),[t,s]=d.exports.useState(1),c=A(),a=d.exports.useCallback(()=>{t===2?s(1):o(()=>[{stage:5}])},[t]),i=d.exports.useCallback(async()=>{t===1?s(2):o(f=>{f.push({stage:2})})},[t]),m=t===1?"1.\u30AA\u30D5\u30A1\u30FC(\u524D\u534A)":"1.\u30AA\u30D5\u30A1\u30FC(\u5F8C\u534A)",l=Fe(n.sdp,t,c,[n],[n,t]);return g(R,{title:m,children:[l&&r("div",{css:u({display:"flex",justifyContent:"center",width:"100%",marginBottom:"1rem"}),children:r(Re,{src:l,cacheKey:`host-offer-${t}`})}),r("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:r("span",{children:"\u63A5\u7D9A\u3059\u308B\u30B2\u30B9\u30C8\u306B\u63D0\u793A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"})}),t===2&&r("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:"\u300C\u6B21\u3078\u300D\u3092\u62BC\u3059\u3068\u30AB\u30E1\u30E9\u304C\u8D77\u52D5\u3057\u307E\u3059\u3002"}),r(G,{backTitle:t===2?"\u623B\u308B":"\u30B2\u30B9\u30C8\u4E00\u89A7",nextTitle:"\u6B21\u3078",onBack:a,onNext:i})]})}),ce=({onResult:e})=>{const n=d.exports.useRef(null),o=d.exports.useRef(null),t=A(),[s,c]=d.exports.useState(void 0),{color:a}=_();return d.exports.useEffect(()=>{const m=(async()=>{if(!s)return;const l=o.current;if(!l)return;const f=n.current;if(f==null){t.error("Failed to get canvas element.");return}const v=f.getContext("2d");if(v==null){t.error("Failed to get canvas context");return}return requestAnimationFrame(function B(){const C=n.current;if(C==null)return;if(l.readyState!==l.HAVE_ENOUGH_DATA){setTimeout(()=>{B()},200);return}C.width=l.videoWidth,C.height=l.videoHeight,v.drawImage(l,0,0,C.width,C.height);const S=v.getImageData(0,0,C.width,C.height),F=Oe(S.data,S.width,S.height,{inversionAttempts:"dontInvert"});if(!F){requestAnimationFrame(B);return}e(F),s.getTracks().forEach(M=>{M.readyState==="live"&&M.stop()})}),s})().catch(l=>{t.error(`Cannot get video stream: ${String(l)}`)});return()=>{m.then(l=>{l&&l.getTracks().forEach(f=>{f.readyState==="live"&&f.stop()})})}},[s]),g("div",{css:u({width:"100%",display:"flex",alignItems:"center",justifyContent:"center",flexWrap:"wrap"}),children:[r("video",{css:u({display:"block",width:"80%"}),ref:o,autoPlay:!0,muted:!0,playsInline:!0}),r("div",{css:u({width:"100%"}),children:r("canvas",{css:u({display:"none",width:"100%"}),ref:n})}),r("div",{css:u({width:"100%",display:"flex",justifyContent:"center"}),children:!s&&r("button",{css:u({width:"50%",height:"2rem",border:"none",outline:"none",background:a.primary.main}),onClick:()=>{Qe().then(i=>{t.info("stream acquired."),o.current&&(t.info("attached to video."),o.current.srcObject=i,o.current.play().then(()=>{t.info("video started")})),c(i)})},children:"\u30AB\u30E1\u30E9\u3092\u8D77\u52D5\u3059\u308B"})})]})},it=()=>{const[e,n]=d.exports.useState(void 0),o=k(I),t=A(),s=d.exports.useCallback(i=>{t.info("answer1 received:"),n(i.binaryData)},[]),c=d.exports.useCallback(()=>{o(i=>{i.pop()})},[]),a=d.exports.useCallback(async()=>{e!=null&&o(i=>{i.push({stage:3,halfAnswer:e})})},[e]);return g(R,{title:"2.\u30A2\u30F3\u30B5\u30FC\u53D7\u4FE1(\u524D\u534A)",children:[e==null&&r(ce,{onResult:s}),r(G,{backTitle:"\u623B\u308B",onBack:c,nextTitle:e!=null?"\u6B21\u3078":void 0,onNext:a})]})},ut=({stage:e})=>{const[n,o]=d.exports.useState(void 0),t=k(I),s=A(),c=d.exports.useCallback(i=>{s.info("answer2 received:");const m=_e(new Uint8Array([...e.halfAnswer,...i.binaryData]));m!=null?(o(m),t(l=>{l.push({stage:4,sdp:m})})):s.error("Decoding SDP Failed")},[]),a=d.exports.useCallback(()=>{t(i=>{o(void 0),i.pop()})},[]);return g(R,{title:"3.\u30A2\u30F3\u30B5\u30FC\u53D7\u4FE1(\u5F8C\u534A)",children:[n==null&&r(ce,{onResult:c}),r(G,{backTitle:"\u623B\u308B",onBack:a})]})},dt=({stage:e,peer:n,service:o})=>{const t=A(),s=k(I);return console.log("here"),d.exports.useEffect(()=>{(async()=>{await n.connect(e.sdp);const a={type:"acceptGuest",guestId:n.id,others:await Promise.all(Array.from(o.getPeers().values()).filter(i=>i.id!==n.id).map(async i=>({id:i.id,name:await i.getName()})))};await n.sendMessage(a),s(()=>[{stage:5}])})().catch(a=>{t.error(`Failed to receive answer: ${String(a)}`)})},[]),r(R,{title:"4. \u63A5\u7D9A\u4E2D",children:r("p",{children:"\u63A5\u7D9A\u4E2D\u3067\u3059..."})})},Te=()=>{const[e,n]=Z(ne),{color:o}=_();return g("div",{css:u({width:"100%",marginTop:"3rem"}),children:[g("div",{css:u({width:"100%",display:"flex",justifyContent:"center"}),children:[!e.speaker.unlockLimit&&r("button",{css:u({width:"100%",maxWidth:"500px",height:"2rem",border:"none",outline:"none",background:o.alert.main}),onClick:()=>{n(t=>{t.speaker.unlockLimit=!0})},children:"\u30DC\u30EA\u30E5\u30FC\u30E0\u30A2\u30F3\u30ED\u30C3\u30AF"}),e.speaker.unlockLimit&&r("button",{css:u({width:"100%",maxWidth:"500px",height:"2rem",border:"none",outline:"none",background:o.alert.main}),onClick:()=>{e.speaker.volume>1&&n(t=>{t.speaker.volume=1}),n(t=>{t.speaker.unlockLimit=!1})},children:"\u30DC\u30EA\u30E5\u30FC\u30E0\u4E0A\u9650\u30ED\u30C3\u30AF"})]}),r("p",{children:"\u30A4\u30E4\u30DB\u30F3\u3092\u5229\u7528\u3057\u3066\u3044\u308B\u5834\u5408\u3001\u30A2\u30F3\u30ED\u30C3\u30AF\u3059\u308B\u3068\u975E\u5E38\u306B\u5927\u304D\u306A\u97F3\u304C\u51FA\u308B\u5834\u5408\u304C\u3042\u308A\u307E\u3059\u3002"})]})},lt=({textP:e})=>{const[n,o]=d.exports.useState(void 0);return d.exports.useEffect(()=>{e.then(t=>{o(t)})},[]),r(N,{children:n!=null?n:""})},ft=({service:e,setCurrentPeer:n})=>{const o=e.getPeers(),[t,s]=d.exports.useState(void 0),c=k(I);Ae();const{color:a}=_();return d.exports.useEffect(()=>{for(const i of o.values())i.getConnectionState()!=="connected"&&i.close()},[]),g(R,{title:"\u30B2\u30B9\u30C8\u4E00\u89A7",children:[g("div",{children:[o.size===0&&r("p",{css:u({marginBottom:"5rem"}),children:"\u307E\u3060\u63A5\u7D9A\u306F\u3042\u308A\u307E\u305B\u3093\u3002"}),g("div",{css:u({display:"flex",justifyContent:"center"}),children:[r("button",{type:"button",css:u({border:"none",outline:"none",padding:"0.5rem 1rem",background:a.primary.main}),onClick:async()=>{const i=await e.createPeer();n(i),c(()=>[{stage:1,sdp:i.sdp}])},children:"\u65B0\u898F\u63A5\u7D9A"}),r("button",{type:"button",css:u({border:"none",outline:"none",padding:"0.5rem 1rem",background:a.primary.main}),onClick:()=>{if(t==null){const i=e.startRecording();s(i);return}t.getRecordState()==="paused"&&t.resume(),t.getRecordState()==="recording"&&t.pause()},children:t?"\u9332\u97F3\u505C\u6B62":"\u9332\u97F3\u958B\u59CB"}),t&&r("button",{type:"button",css:u({border:"none",outline:"none",padding:"0.5rem 1rem",background:a.primary.main}),onClick:()=>{t.clear(),s(void 0)},children:"\u30AF\u30EA\u30A2"}),t&&t.getRecordState()==="paused"&&r("button",{type:"button",css:u({border:"none",outline:"none",padding:"0.5rem 1rem",background:a.primary.main}),onClick:()=>{t.save()},children:"\u4FDD\u5B58"})]}),o.size>0&&r("ol",{css:u({display:"flex",flexWrap:"wrap",padding:"1rem",width:"100%"}),children:[...o.values()].map(i=>g("li",{css:u({display:"flex",justifyContent:"space-between",width:"100%"}),children:[r("span",{css:u({marginRight:"1rem"}),children:i.id.slice(0,6)}),r("span",{css:u({marginRight:"1rem"}),children:r(lt,{textP:i.getName()})}),r("span",{children:i.getConnectionState()}),r("button",{type:"button",css:u({border:"none",outline:"none",width:"2rem",background:a.secondary.dark}),onClick:()=>{i.close()},children:"\xD7"})]},i.id))})]}),r(Te,{})]})},mt=({service:e,peer:n,setCurrentPeer:o})=>{const t=P(I),s=t[t.length-1];return s==null?null:s.stage===1?r(at,{stage:s}):s.stage===2?r(it,{}):s.stage===3?r(ut,{stage:s}):s.stage===4?r(dt,{service:e,stage:s,peer:n}):s.stage===5?r(ft,{service:e,setCurrentPeer:o}):r(N,{})},Pe=({service:e})=>{const n=P(ne);return d.exports.useEffect(()=>{e.changeVolume(n.mic.muted?0:n.mic.volume)},[n.mic.volume,n.mic.muted]),r(N,{})},pt=()=>{const[e,n]=d.exports.useState(),[o,t]=d.exports.useState(),s=A(),c=d.exports.useRef(null),a=d.exports.useCallback(async i=>{if(c.current==null){s.warn("ignore playAudio() since no audio element found.");return}c.current.srcObject=i,await c.current.play()},[]);return g("main",{css:u({width:"100%",height:"100%",maxWidth:1200}),children:[!e&&r(et,{setService:n,setCurrentPeer:t,playAudio:a}),e&&o!=null&&r(mt,{service:e,peer:o,setCurrentPeer:t}),r(xe,{audioRef:c}),e&&r(Pe,{service:e})]})},gt=async(e,n,o,t)=>{const s=new AudioContext,c=s.createMediaStreamDestination(),a=await navigator.mediaDevices.getUserMedia({video:!1,audio:{latency:.01,echoCancellation:!0}});E(a);const[i,m]=we(s,a);E(m),await e(c.stream);const[l,f]=W(),[v,w]=W(),B=async()=>{const p=new RTCPeerConnection({iceServers:[]}),y=m.clone();E(y);for(const D of y.getTracks())p.addTrack(D,y);return de(p,s,c,n,e),p.onconnectionstatechange=()=>{n.info(`host connection state change: ${p.connectionState}`)},p.ondatachannel=D=>{n.info("data channel established"),l(D.channel)},v(p),p},C=async p=>{const y=await w();await y.setRemoteDescription({type:"offer",sdp:p});const D=await y.createAnswer();return await y.setLocalDescription(D),new Promise(h=>{y.onicecandidate=L=>{!L.candidate&&y.localDescription!=null&&h(y.localDescription.sdp)}})},S=async p=>{const y=await w();y.onconnectionstatechange=()=>{y.connectionState==="connected"&&(n.info("connected to host"),p())}},M=Ke(o,f,p=>{const y=m.clone();E(y);for(const D of y.getTracks())p.addTrack(D,y);de(p,s,c,n,e)},n,t);return{createAnswer:C,setOnConnect:S,close:async()=>(await w()).close(),signalService:M,createHostPeer:B,changeVolume:i}},ht=We("guestName","\u306A\u306A\u3057\u3055\u3093"),V=Y([]),yt=({setService:e,playAudio:n})=>{const o=A(),{color:t}=_(),s=k(ue),[c,a]=Z(ht),i=k(V),m=ke();return r("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}),children:g("div",{css:u({width:"100%",padding:"2rem"}),children:[r("div",{css:u({display:"flex",width:"100%",justifyContent:"center",marginBottom:"3rem"}),children:r("input",{type:"text",css:u({outline:"none",border:"none",fontSize:"1rem",padding:"0.25rem 0.5rem",height:"3rem",width:"14rem"}),onChange:l=>{a(l.target.value)},value:c})}),r("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%"}),children:r("button",{type:"button",css:u({padding:"0.5rem 1rem",outline:"none",border:"none",background:t.primary.main,color:t.primary.text,fontSize:"1.5rem",width:"14rem"}),onClick:async()=>{const l=await gt(n,o,c,m);e(l),s(!0),i(f=>{f.push({stage:1})})},children:"\u63A5\u7D9A\u958B\u59CB"})})]})})},bt=()=>{const[e,n]=d.exports.useState(void 0),o=k(V),t=A(),s=d.exports.useCallback(async a=>{t.info("offer1 received:"),n(a.binaryData)},[]),c=d.exports.useCallback(async()=>{e!=null&&o(a=>{a.push({stage:2,halfOffer:e})})},[e]);return g(R,{title:"1.\u30AA\u30D5\u30A1\u30FC\u53D7\u4FE1(\u524D\u534A)",children:[e==null&&r(ce,{onResult:s}),e&&r(G,{nextTitle:"\u6B21\u3078",onNext:c})]})},wt=({stage:e,service:n})=>{const[o,t]=d.exports.useState(void 0),s=k(V),c=A(),a=d.exports.useCallback(async m=>{c.info("offer2 received:");const l=_e(new Uint8Array([...e.halfOffer,...m.binaryData]));if(console.log(l),t(l),l!=null){t(l),await n.createHostPeer();const f=await n.createAnswer(l);s(v=>{console.log("answer sdp:",f),v.push({stage:3,sdp:f})})}},[]),i=d.exports.useCallback(()=>{t(void 0),s(m=>{m.pop()})},[]);return g(R,{title:"2.\u30AA\u30D5\u30A1\u30FC\u53D7\u4FE1(\u5F8C\u534A)",children:[o==null&&r(ce,{onResult:a}),r(G,{backTitle:"\u623B\u308B",onBack:i})]})},vt=({stage:e,service:n})=>{const o=k(V),[t,s]=d.exports.useState(1),c=A(),a=t===1?"3.\u30A2\u30F3\u30B5\u30FC(\u524D\u534A)":"3.\u30A2\u30F3\u30B5\u30FC(\u5F8C\u534A)",i=Fe(e.sdp,t,c,[e],[e,t]),m=d.exports.useCallback(()=>{t===1&&s(2)},[]),l=d.exports.useCallback(()=>{if(t===2){s(1);return}o(f=>{f.pop(),f.pop()})},[]);return d.exports.useLayoutEffect(()=>{n.setOnConnect(()=>{o(f=>{f.push({stage:4})})})},[]),g(R,{title:a,children:[i&&r("div",{css:u({display:"flex",justifyContent:"center",width:"100%",marginBottom:"1rem"}),children:r(Re,{src:i,cacheKey:`guest-answer-${t}`})}),r("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:r("span",{children:`\u30DB\u30B9\u30C8\u306BQR\u30B3\u30FC\u30C9\u3092${t===2?"\u3082\u3046\u4E00\u5EA6":""}\u63D0\u793A\u3057\u3066\u304F\u3060\u3055\u3044\u3002`})}),r(G,{backTitle:"\u623B\u308B",nextTitle:t===1?"\u6B21\u3078":void 0,onNext:m,onBack:l})]})},Ct=()=>{const e=k(V);return console.log("here"),d.exports.useEffect(()=>{e(()=>[{stage:5}])},[]),r(R,{title:"4. \u63A5\u7D9A\u4E2D",children:r("p",{children:"\u63A5\u7D9A\u4E2D\u3067\u3059..."})})},St=({service:e})=>{const n=e.signalService.peers;return Ae(),g(R,{title:"\u63A5\u7D9A\u4E00\u89A7",children:[g("ol",{children:[r("li",{children:"\u30DB\u30B9\u30C8"}),Array.from(n.values()).map(o=>r("li",{children:`${o.id.slice(0,6)} ${o.name}`},o.id))]}),r(Te,{})]})},kt=({service:e})=>{const n=P(V),o=n[n.length-1];return o==null?null:o.stage===1?r(bt,{}):o.stage===2?r(wt,{stage:o,service:e}):o.stage===3?r(vt,{stage:o,service:e}):o.stage===4?r(Ct,{}):o.stage===5?r(St,{service:e}):r(N,{})},At=()=>{const e=d.exports.useRef(null),n=A(),[o,t]=d.exports.useState(void 0),s=d.exports.useCallback(async c=>{if(e.current==null){n.warn("ignore playAudio() since no audio element found.");return}e.current.srcObject=c,await e.current.play()},[]);return g("main",{css:u({width:"100%",height:"100%",maxWidth:1200}),children:[o==null&&r(yt,{setService:t,playAudio:s}),o&&r(kt,{service:o}),r(xe,{audioRef:e}),o&&r(Pe,{service:o})]})},xt=()=>{const[e,n]=Z(te),o=P(ue),t=A(),{color:s}=_(),c=e==="host"?"\u30DB\u30B9\u30C8":"\u30B2\u30B9\u30C8",a=e==="host"?"\u30B2\u30B9\u30C8":"\u30DB\u30B9\u30C8";return r("button",{className:ee({started:o}),css:u({width:"9rem",border:"none",outline:"none",padding:"0.125rem 0.5rem",background:`linear-gradient(135deg, ${s.primary.main} 50%, ${s.secondary.main} 50%)`,color:s.primary.text,"&.started":{background:s.background.dark,color:s.text}}),type:"button",onClick:()=>{if(o){t.warn("\u30BB\u30C3\u30B7\u30E7\u30F3\u304C\u958B\u59CB\u3055\u308C\u3066\u3044\u307E\u3059\u3002\u30E2\u30FC\u30C9\u3092\u5909\u66F4\u3067\u304D\u307E\u305B\u3093\u3002");return}n(i=>i==="host"?"guest":"host")},disabled:o,children:o?r("span",{children:c}):g(N,{children:[r("span",{css:u({fontWeight:"bolder"}),children:`[${c}]`})," \u21D2 ",r("span",{children:a})]})})},Dt=()=>{const{color:e}=_(),[n,o]=d.exports.useState("");return d.exports.useEffect(()=>{const t=Array.from(document.getElementsByTagName("script"));for(const s of t){const c=/index\.([^.]+)\.js$/.exec(s.src);if(c){o(c[1]);break}}},[]),g("header",{css:u({display:"flex",justifyContent:"space-between",alignItems:"center",height:"100%",paddingLeft:"0.5rem",paddingRight:"1rem",background:e.background.light}),children:[g("span",{children:["QR WebRTC",n?` -${n}`:""]}),r(xt,{})]})},Bt=X.memo(function({item:n}){const{timestamp:o,level:t,message:s}=n,a=`${[o.getHours(),o.getMinutes(),o.getSeconds()].map(i=>i.toString(10).padStart(2,"0")).join(":")} [${t.toUpperCase()}] ${s}`;return r("li",{className:t,css:u({fontFamily:"monospace","&.info":{color:"#bdbdbd"},"&.warn":{color:"#ffa726"},"&.error":{color:"#ef5350"},"&.success":{color:"#29b6f6"}}),children:a})}),_t=X.memo(function({items:n}){return r("ul",{css:u({height:"100%",paddingLeft:"0.5rem"}),children:n.map(o=>r(Bt,{item:o},o.id))})}),Le=({value:e,setValue:n,onMuteClick:o,icon:t,unlock:s})=>g("div",{css:u({display:"block"}),children:[r("input",{type:"range",step:s?.1:.01,min:0,max:s?8:1,value:e,onChange:c=>{n(c.currentTarget.value)}}),r("button",{css:u({outline:"none",border:"none",background:"transparent"}),type:"button",onClick:o,children:t})]}),Et=()=>{const[e,n]=Z(ne);return g("div",{css:u({display:"flex",alignItems:"center",justifyContent:"space-around",width:"100%"}),children:[r("div",{css:u({display:"block"}),children:r(Le,{value:e.mic.volume,onMuteClick:()=>{n(o=>{o.mic.muted=!o.mic.muted})},setValue:o=>{n(t=>{t.mic.volume=Number(o)})},icon:e.mic.muted?"\u{1F515}":"\u{1F3A4}",unlock:!1})}),r("div",{css:u({display:"block"}),children:r(Le,{value:e.speaker.volume,onMuteClick:()=>{n(o=>{o.speaker.muted=!o.speaker.muted})},setValue:o=>{n(t=>{t.speaker.volume=Number(o)})},icon:e.speaker.muted?"\u{1F507}":"\u{1F50A}",unlock:e.speaker.unlockLimit})})]})},Rt=()=>{const[e,n]=d.exports.useState(!1),{color:o}=_(),t=ze(),s=t.length>0&&t[t.length-1].level==="error";return d.exports.useEffect(()=>{s&&n(!0)},[s]),g("footer",{className:ee({open:e}),css:u({display:"grid",height:"3.5rem",gridTemplateRows:"2rem 1.5rem 1fr",overflow:"hidden",transition:"all 0.5s","&.open":{height:"12rem"},background:o.background.dark,color:o.text}),children:[r("div",{css:u({display:"flex",alignItems:"center",borderBottom:`1px solid ${o.primary.dark}`,width:"100%"}),children:r(Et,{})}),g("button",{type:"button",className:ee({error:s}),css:u({display:"flex",justifyContent:"right",alignItems:"center",width:"100%",height:"100%",paddingRight:"1rem",border:"none",outline:"none",background:o.background.dark,color:o.text,"&.error":{background:"#b61827"}}),onClick:()=>n(c=>!c),children:[r("span",{css:u({marginRight:"0.75rem"}),children:"\u30ED\u30B0"}),r("span",{className:ee({open:e}),css:u({display:"inline-block",height:"0.75rem",width:"0.75rem",borderLeft:"0.375rem solid transparent",borderBottom:"0.75rem solid white",borderRight:"0.375rem solid transparent",transition:"all 0.5s","&.open":{transform:"rotate(-180deg)"}})})]}),r("div",{css:u({height:"100%",overflowY:"scroll",borderTop:`1px solid ${o.primary.dark}`,scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"}}),children:r(_t,{items:t})})]})},Ft=({children:e})=>{const{color:n}=_();return g(N,{children:[g("div",{css:u({display:"grid",width:"100%",height:"100%",gridTemplateRows:"2.5rem 1fr auto"}),children:[r("div",{css:u({height:"100%"}),children:r(Dt,{})}),r("div",{css:u({height:"100%",display:"flex",justifyContent:"center"}),children:e}),r("div",{css:u({height:"100%"}),children:r(Rt,{})})]}),r(je,{styles:u({"html, body, #root":{height:"100%"},"*":{boxSizing:"border-box",margin:0,padding:0},"ul, ol":{margin:0,padding:0,listStyleType:"none"},body:{background:n.background.main,color:n.text,margin:0,padding:0}})})]})},Tt=()=>{const e=P(te),n=k(te);return d.exports.useLayoutEffect(()=>{Ee().catch(s=>{console.error(s)});const t=new URLSearchParams(window.location.hash.substring(1)).get("as")||"host";n(t==="host"?"host":"guest")},[]),O(Ft,{children:e==="host"?O(pt,{}):O(At,{})})},Pt=({children:e})=>r(He,{children:e});function Lt(e={}){const{immediate:n=!1,onNeedRefresh:o,onOfflineReady:t,onRegistered:s,onRegisterError:c}=e;let a,i;const m=async(l=!0)=>{l&&(a==null||a.addEventListener("controlling",f=>{f.isUpdate&&window.location.reload()})),i&&i.waiting&&await Ge(i.waiting,{type:"SKIP_WAITING"})};if("serviceWorker"in navigator){a=new Ue("/qr-webrtc-dev/sw.js",{scope:"/qr-webrtc-dev/"}),a.addEventListener("activated",l=>{l.isUpdate||t==null||t()});{const l=()=>{o==null||o()};a.addEventListener("waiting",l),a.addEventListener("externalwaiting",l)}a.register({immediate:n}).then(l=>{i=l,s==null||s(l)}).catch(l=>{c==null||c(l)})}return m}Lt();Ve.render(O(X.StrictMode,{children:O(Pt,{children:O(Tt,{})})}),document.getElementById("root"));
