import{a as te,b as Ee,c as q,u as k,r as l,n as de,d as T,t as G,l as z,s as D,e as le,j as c,f as u,g,R as Q,h as Re,F as L,i as Te,k as ne,m as J,G as Fe,o as $,P as Pe,v as Ie,p as Me,q as Le}from"./vendor.36d518d7.js";const $e=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}};$e();const oe=te(!1),Y=Ee("as","host",{replaceState:!0,serialize:e=>e,deserialize:e=>e==="host"?"host":"guest"}),fe=q([]),Ne=()=>T(fe),A=()=>{const e=k(fe),t=n=>l.exports.useCallback(o=>{console[n==="info"||n==="success"?"log":n](o);const r=new Date,a=de();return e(i=>{i.unshift({message:o,timestamp:r,level:n,id:a})})},[]);return{info:t("info"),warn:t("warn"),error:t("error"),success:t("success")}},se=q({mic:{volume:1,muted:!1},speaker:{volume:1,muted:!1}});te(void 0);const F=()=>{const e=T(Y),t={main:"#282828",dark:"#000000",light:"#404040"},n={main:"#81d4fa",light:"#b6ffff",dark:"#4ba3c7",text:"#202020"},o={main:"#ffee58",light:"#ffff8b",dark:"#c9bc1f",text:"#202020"};return{color:{background:t,primary:e==="host"?n:o,secondary:e==="host"?o:n,text:"#E8E8E8"}}},P=e=>{let t=new Audio;t.muted=!0,t.srcObject=e,t.addEventListener("canplaythrough",()=>{t=null})},re=(e,t,n,o,s)=>{"ontrack"in e?(o.info("set ontrack event"),e.ontrack=r=>{o.info("ontrack event detected");for(const a of r.streams)o.info("loop on stream"),P(a),t.createMediaStreamSource(a).connect(n),s(n.stream).then(()=>{o.info("update stream")})}):(o.info("set onaddstream event"),e.onaddstream=r=>{o.info("onaddstream event detected"),P(r.stream),t.createMediaStreamSource(r.stream).connect(n),s(n.stream).then(()=>{o.info("update stream")})})},me=(e,t)=>{const n=e.createGain(),o=e.createMediaStreamDestination();return e.createMediaStreamSource(t).connect(n),n.connect(o),[a=>{n.gain.setValueAtTime(a,e.currentTime)},o.stream]},Oe=async()=>await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}}),U=()=>{let e=()=>{};const t=new Promise(n=>{e=n});return[n=>e(n),()=>t]},We=G({type:z("acceptGuest"),guestId:D,others:le(G({id:D,name:D}))}),pe=G({type:z("offer"),from:D,name:D,to:D,sdp:D}),je=G({type:z("acceptHost"),guestId:D,name:D,offers:le(pe)}),ge=G({type:z("answer"),from:D,to:D,sdp:D}),He=(e,t,n,o,s)=>{const r=new Map,[a,i]=U();return t().then(async m=>{m.onmessage=async d=>{const f=JSON.parse(d.data);if(We.is(f)){o.info("accepted by host");const v=f.guestId;a(f.guestId);const y=[];for(const C of f.others){const w=new RTCPeerConnection({iceServers:[]});n(w);const p={peer:w,id:C.id,name:C.name};r.set(C.id,p),await w.setLocalDescription(await w.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}));const _=await new Promise(I=>{w.onicecandidate=S=>{!S.candidate&&w.localDescription&&I(w.localDescription.sdp)}});y.push({type:"offer",from:v,to:C.id,name:e,sdp:_}),w.onconnectionstatechange=()=>{o.info(`connection state change to ${p.id}: ${w.connectionState}`),s()}}const x={type:"acceptHost",guestId:v,offers:y,name:e};m.send(JSON.stringify(x))}if(pe.is(f)){o.info(`received offer from: ${f.from}`);const v=await i(),y=new RTCPeerConnection({iceServers:[]});n(y),r.set(f.from,{id:f.from,peer:y,name:f.name}),await y.setRemoteDescription({type:"offer",sdp:f.sdp}),await y.setLocalDescription(await y.createAnswer()),y.onconnectionstatechange=()=>{o.info(`connection state change to ${f.from}: ${y.connectionState}`),s()};const x=await new Promise(w=>{y.onicecandidate=p=>{!p.candidate&&y.localDescription&&w(y.localDescription.sdp)}}),C={type:"answer",from:v,to:f.from,sdp:x};m.send(JSON.stringify(C))}if(ge.is(f)){o.info(`received answer from ${f.from}`);const v=r.get(f.from);if(v==null)return;v.peer.onconnectionstatechange=()=>{o.info(`connection state change to ${f.from}: ${v.peer.connectionState}`),s()},await v.peer.setRemoteDescription({type:"answer",sdp:f.sdp})}}}),{peers:r}},Ge=(e,t)=>(n,o)=>{if(je.is(o)){t.info(`${o.guestId.slice(0,5)} / accepted by guest`);const s=e.get(o.guestId);if(s==null)return;s.setName(o.name);for(const r of o.offers){t.info(`${r.to.slice(0,5)} / sending offer`);const a=e.get(r.to);a!=null&&a.sendMessage(r)}}if(ge.is(o)){const s=e.get(o.to);if(t.info(`${o.to.slice(0,5)} / sending answer from ${o.from.slice(0,5)}`),s==null)return;s.sendMessage(o)}},Ue=async(e,t,n)=>{const o=new Map,s=new AudioContext,r=s.createMediaStreamDestination(),a=await navigator.mediaDevices.getUserMedia({video:!1,audio:{latency:.01,echoCancellation:!0}});P(a);const[i,m]=me(s,a);await e(r.stream);const d=Ge(o,t);return{createPeer:async()=>{const x=de(),[C,w]=U(),p=new RTCPeerConnection({iceServers:[]}),_=m.clone();P(_);for(const R of _.getTracks())p.addTrack(R,_);re(p,s,r,t,e),p.onconnectionstatechange=()=>{t.info(`${x.slice(0,5)} / connection state change: ${p.connectionState}`),n()};const I=p.createDataChannel("host-to-guest"),[S,b]=U();I.onopen=()=>{t.info(`${x.slice(0,5)} / data channel established`),S(I)},I.onmessage=R=>{d(x,JSON.parse(R.data))},await p.setLocalDescription(await p.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1}));const E=await new Promise(R=>{p.onicecandidate=V=>{!V.candidate&&p.localDescription&&R(p.localDescription.sdp)}}),ue={id:x,sdp:E,connect:async R=>{const V=new Promise(Be=>{p.onconnectionstatechange=()=>{t.info(`${x.slice(0,5)} / connection state change: ${p.connectionState}`),n(),p.connectionState==="connected"&&Be()}});return await p.setRemoteDescription({type:"answer",sdp:R}),V},close:()=>{p.close(),o.delete(x),n()},getConnectionState:()=>p.connectionState,sendMessage:async R=>{(await b()).send(JSON.stringify(R))},data:I,setName:C,getName:w};return o.set(x,ue),ue},getPeer:x=>o.get(x),getPeers:()=>o,changeVolume:i}},M=q([]),he=te({}),ye=()=>{const e=k(he);return l.exports.useCallback(()=>{e(Symbol())},[])},we=()=>{T(he)},Ve=({setService:e,setCurrentPeer:t,playAudio:n})=>{const{color:o}=F(),s=k(oe),r=k(M),a=A(),i=ye();return c("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}),children:c("button",{type:"button",css:u({padding:"0.5rem 1rem",outline:"none",border:"none",background:o.primary.main,color:o.primary.text,fontSize:"1.5rem",width:"14rem"}),onClick:async()=>{const m=await Ue(n,a,i),d=await m.createPeer();e(m),s(!0),t(d),r(f=>{console.log("offer sdp:",d.sdp),f.push({stage:1,sdp:d.sdp})})},children:"\u63A5\u7D9A\u958B\u59CB"})})},be=({audioRef:e})=>{const t=T(se);return l.exports.useEffect(()=>{e.current&&(e.current.volume=t.speaker.muted?0:t.speaker.volume)},[t.speaker.volume,t.speaker.muted]),c("div",{children:c("audio",{autoPlay:!0,ref:e})})};let h,ve=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});ve.decode();let K=null;function N(){return(K===null||K.buffer!==h.memory.buffer)&&(K=new Uint8Array(h.memory.buffer)),K}function ce(e,t){return ve.decode(N().subarray(e,e+t))}let O=0,X=new TextEncoder("utf-8");const qe=typeof X.encodeInto=="function"?function(e,t){return X.encodeInto(e,t)}:function(e,t){const n=X.encode(e);return t.set(n),{read:e.length,written:n.length}};function ze(e,t,n){if(n===void 0){const i=X.encode(e),m=t(i.length);return N().subarray(m,m+i.length).set(i),O=i.length,m}let o=e.length,s=t(o);const r=N();let a=0;for(;a<o;a++){const i=e.charCodeAt(a);if(i>127)break;r[s+a]=i}if(a!==o){a!==0&&(e=e.slice(a)),s=n(s,o,o=a+e.length*3);const i=N().subarray(s+a,s+o);a+=qe(e,i).written}return O=a,s}let Z=null;function W(){return(Z===null||Z.buffer!==h.memory.buffer)&&(Z=new Int32Array(h.memory.buffer)),Z}function Qe(e,t){return N().subarray(e/1,e/1+t)}function Je(e){try{const r=h.__wbindgen_add_to_stack_pointer(-16);var t=ze(e,h.__wbindgen_malloc,h.__wbindgen_realloc),n=O;h.compress(r,t,n);var o=W()[r/4+0],s=W()[r/4+1];let a;return o!==0&&(a=Qe(o,s).slice(),h.__wbindgen_free(o,s*1)),a}finally{h.__wbindgen_add_to_stack_pointer(16)}}function Ce(e,t){const n=t(e.length*1);return N().set(e,n/1),O=e.length,n}function Ye(e,t){try{const a=h.__wbindgen_add_to_stack_pointer(-16);var n=Ce(e,h.__wbindgen_malloc),o=O;h.into_svg(a,n,o,t);var s=W()[a/4+0],r=W()[a/4+1];let i;return s!==0&&(i=ce(s,r).slice(),h.__wbindgen_free(s,r*1)),i}finally{h.__wbindgen_add_to_stack_pointer(16)}}function Se(e){try{const r=h.__wbindgen_add_to_stack_pointer(-16);var t=Ce(e,h.__wbindgen_malloc),n=O;h.inflate(r,t,n);var o=W()[r/4+0],s=W()[r/4+1];let a;return o!==0&&(a=ce(o,s).slice(),h.__wbindgen_free(o,s*1)),a}finally{h.__wbindgen_add_to_stack_pointer(16)}}async function Ke(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}async function xe(e){typeof e=="undefined"&&(e=new URL("/qr-webrtc-dev/assets/wasm_bg.37a669e8.wasm",self.location));const t={};t.wbg={},t.wbg.__wbg_alert_f5393de24ed74e50=function(s,r){alert(ce(s,r))},(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await Ke(await e,t);return h=n.exports,xe.__wbindgen_wasm_module=o,h}const ke=({src:e,cacheKey:t})=>{const n=l.exports.useRef({}),o=A(),s=l.exports.useMemo(()=>{const r=n.current[t];if(r)return r;const a=Ye(e,300);return a===void 0?(o.error("QR Code creation failed for some reason."),""):(n.current[t]=a,a)},[e,t]);return l.exports.useEffect(()=>{console.log(`${t} generate:`),console.log(e)},[e,t]),c("div",{dangerouslySetInnerHTML:{__html:s}})},j=({backTitle:e,nextTitle:t,onBack:n,onNext:o})=>{const{color:s}=F();return g("ul",{css:u({display:"grid",gridTemplateColumns:"50% 50%",width:"100%",padding:"2rem",gap:"1rem",maxWidth:"400px"}),children:[e!=null&&c("li",{children:c("button",{type:"button",css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:s.primary.main}),onClick:n,children:e})}),t&&c("li",{css:u({display:"flex",justifyContent:"center",alignItems:"center"}),children:c("button",{type:"button",css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:s.primary.main}),onClick:o,children:t})})]})},B=({title:e,children:t})=>g("section",{css:u({display:"flex",flexWrap:"wrap",justifyContent:"center",width:"100%",padding:"1rem"}),children:[c("h2",{css:u({width:"100%",marginBottom:"1rem",fontSize:"larger"}),children:e}),t]}),Ae=(e,t,n,o,s)=>{const r=l.exports.useMemo(()=>{const a=Je(e);if(a==null){n.error("Failed to compress sdp.");return}return new Uint8Array(a)},o);return l.exports.useMemo(()=>(console.log("original bytes",new Blob([e]).size),console.log("compressed",r),r==null?void 0:t===1?r.subarray(0,r.length/2):r.subarray(r.length/2)),s)},Xe=Q.memo(function({stage:t}){const n=k(M),[o,s]=l.exports.useState(1),r=A(),a=l.exports.useCallback(()=>{o===2?s(1):n(()=>[{stage:5}])},[o]),i=l.exports.useCallback(async()=>{o===1?s(2):n(f=>{f.push({stage:2})})},[o]),m=o===1?"1.\u30AA\u30D5\u30A1\u30FC(\u524D\u534A)":"1.\u30AA\u30D5\u30A1\u30FC(\u5F8C\u534A)",d=Ae(t.sdp,o,r,[t],[t,o]);return g(B,{title:m,children:[d&&c("div",{css:u({display:"flex",justifyContent:"center",width:"100%",marginBottom:"1rem"}),children:c(ke,{src:d,cacheKey:`host-offer-${o}`})}),c("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:c("span",{children:"\u63A5\u7D9A\u3059\u308B\u30B2\u30B9\u30C8\u306B\u63D0\u793A\u3057\u3066\u304F\u3060\u3055\u3044\u3002"})}),o===2&&c("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:"\u300C\u6B21\u3078\u300D\u3092\u62BC\u3059\u3068\u30AB\u30E1\u30E9\u304C\u8D77\u52D5\u3057\u307E\u3059\u3002"}),c(j,{backTitle:o===2?"\u623B\u308B":"\u30B2\u30B9\u30C8\u4E00\u89A7",nextTitle:"\u6B21\u3078",onBack:a,onNext:i})]})}),ee=({onResult:e})=>{const t=l.exports.useRef(null),n=l.exports.useRef(null),o=A(),[s,r]=l.exports.useState(void 0),{color:a}=F();return l.exports.useEffect(()=>{const m=(async()=>{if(!s)return;const d=n.current;if(!d)return;const f=t.current;if(f==null){o.error("Failed to get canvas element.");return}const v=f.getContext("2d");if(v==null){o.error("Failed to get canvas context");return}return requestAnimationFrame(function x(){const C=t.current;if(C==null||d.readyState!==d.HAVE_ENOUGH_DATA)return;C.width=d.videoWidth,C.height=d.videoHeight,v.drawImage(d,0,0,C.width,C.height);const w=v.getImageData(0,0,C.width,C.height),p=Re(w.data,w.width,w.height,{inversionAttempts:"dontInvert"});if(!p){requestAnimationFrame(x);return}e(p),s.getTracks().forEach(_=>{_.readyState==="live"&&_.stop()})}),s})().catch(d=>{o.error(`Cannot get video stream: ${String(d)}`)});return()=>{m.then(d=>{d&&d.getTracks().forEach(f=>{f.readyState==="live"&&f.stop()})})}},[s]),g("div",{css:u({width:"100%",display:"flex",alignItems:"center",justifyContent:"center"}),children:[s&&c("canvas",{css:u({width:"80%"}),ref:t}),c("video",{css:u({display:"none"}),ref:n}),c("button",{css:u({width:"100%",height:"2rem",border:"none",outline:"none",background:a.primary.main}),onClick:()=>{Oe().then(i=>{o.info("stream acquired."),n.current&&(o.info("attached to video."),n.current.srcObject=i,n.current.play().then(()=>{o.info("video started")})),r(i)})}})]})},Ze=()=>{const[e,t]=l.exports.useState(void 0),n=k(M),o=A(),s=l.exports.useCallback(i=>{o.info("answer1 received:"),t(i.binaryData)},[]),r=l.exports.useCallback(()=>{n(i=>{i.pop()})},[]),a=l.exports.useCallback(async()=>{e!=null&&n(i=>{i.push({stage:3,halfAnswer:e})})},[e]);return g(B,{title:"2.\u30A2\u30F3\u30B5\u30FC\u53D7\u4FE1(\u524D\u534A)",children:[e==null&&c(ee,{onResult:s}),c(j,{backTitle:"\u623B\u308B",onBack:r,nextTitle:e!=null?"\u6B21\u3078":void 0,onNext:a})]})},et=({stage:e})=>{const[t,n]=l.exports.useState(void 0),o=k(M),s=A(),r=l.exports.useCallback(i=>{s.info("answer2 received:");const m=Se(new Uint8Array([...e.halfAnswer,...i.binaryData]));m!=null?(n(m),o(d=>{d.push({stage:4,sdp:m})})):s.error("Decoding SDP Failed")},[]),a=l.exports.useCallback(()=>{o(i=>{n(void 0),i.pop()})},[]);return g(B,{title:"3.\u30A2\u30F3\u30B5\u30FC\u53D7\u4FE1(\u5F8C\u534A)",children:[t==null&&c(ee,{onResult:r}),c(j,{backTitle:"\u623B\u308B",onBack:a})]})},tt=({stage:e,peer:t,service:n})=>{const o=A(),s=k(M);return console.log("here"),l.exports.useEffect(()=>{(async()=>{await t.connect(e.sdp);const a={type:"acceptGuest",guestId:t.id,others:await Promise.all(Array.from(n.getPeers().values()).filter(i=>i.id!==t.id).map(async i=>({id:i.id,name:await i.getName()})))};await t.sendMessage(a),s(()=>[{stage:5}])})().catch(a=>{o.error(`Failed to receive answer: ${String(a)}`)})},[]),c(B,{title:"4. \u63A5\u7D9A\u4E2D",children:c("p",{children:"\u63A5\u7D9A\u4E2D\u3067\u3059..."})})},nt=({textP:e})=>{const[t,n]=l.exports.useState(void 0);return l.exports.useEffect(()=>{e.then(o=>{n(o)})},[]),c(L,{children:t!=null?t:""})},ot=({service:e,setCurrentPeer:t})=>{const n=e.getPeers(),o=k(M);we();const{color:s}=F();return l.exports.useEffect(()=>{for(const r of n.values())r.getConnectionState()!=="connected"&&r.close()},[]),c(B,{title:"\u30B2\u30B9\u30C8\u4E00\u89A7",children:g("div",{children:[n.size===0&&c("p",{css:u({marginBottom:"5rem"}),children:"\u307E\u3060\u63A5\u7D9A\u306F\u3042\u308A\u307E\u305B\u3093\u3002"}),c("div",{css:u({display:"flex",justifyContent:"center"}),children:c("button",{type:"button",css:u({border:"none",outline:"none",padding:"0.5rem 1rem",background:s.primary.main}),onClick:async()=>{const r=await e.createPeer();t(r),o(()=>[{stage:1,sdp:r.sdp}])},children:"\u65B0\u898F\u63A5\u7D9A"})}),n.size>0&&c("ol",{css:u({display:"flex",flexWrap:"wrap",padding:"1rem",width:"100%"}),children:[...n.values()].map(r=>g("li",{css:u({display:"flex",justifyContent:"space-between",width:"100%"}),children:[c("span",{css:u({marginRight:"1rem"}),children:r.id.slice(0,6)}),c("span",{css:u({marginRight:"1rem"}),children:c(nt,{textP:r.getName()})}),c("span",{children:r.getConnectionState()}),c("button",{type:"button",css:u({border:"none",outline:"none",width:"2rem",background:s.secondary.dark}),onClick:()=>{r.close()},children:"\xD7"})]},r.id))})]})})},st=({service:e,peer:t,setCurrentPeer:n})=>{const o=T(M),s=o[o.length-1];return s==null?null:s.stage===1?c(Xe,{stage:s}):s.stage===2?c(Ze,{}):s.stage===3?c(et,{stage:s}):s.stage===4?c(tt,{service:e,stage:s,peer:t}):s.stage===5?c(ot,{service:e,setCurrentPeer:n}):c(L,{})},De=({service:e})=>{const t=T(se);return l.exports.useEffect(()=>{e.changeVolume(t.mic.muted?0:t.mic.volume)},[t.mic.volume,t.mic.muted]),c(L,{})},rt=()=>{const[e,t]=l.exports.useState(),[n,o]=l.exports.useState(),s=A(),r=l.exports.useRef(null),a=l.exports.useCallback(async i=>{if(r.current==null){s.warn("ignore playAudio() since no audio element found.");return}r.current.srcObject=i,await r.current.play()},[]);return g("main",{css:u({width:"100%",height:"100%",maxWidth:1200}),children:[!e&&c(Ve,{setService:t,setCurrentPeer:o,playAudio:a}),e&&n!=null&&c(st,{service:e,peer:n,setCurrentPeer:o}),c(be,{audioRef:r}),e&&c(De,{service:e})]})},ct=async(e,t,n,o)=>{const s=new AudioContext,r=s.createMediaStreamDestination(),a=await navigator.mediaDevices.getUserMedia({video:!1,audio:{latency:.01,echoCancellation:!0}});P(a);const[i,m]=me(s,a);P(m),await e(r.stream);const[d,f]=U(),[v,y]=U(),x=async()=>{const S=new RTCPeerConnection({iceServers:[]}),b=m.clone();P(b);for(const E of b.getTracks())S.addTrack(E,b);return re(S,s,r,t,e),S.onconnectionstatechange=()=>{t.info(`host connection state change: ${S.connectionState}`)},S.ondatachannel=E=>{t.info("data channel established"),d(E.channel)},v(S),S},C=async S=>{const b=await y();await b.setRemoteDescription({type:"offer",sdp:S});const E=await b.createAnswer();return await b.setLocalDescription(E),new Promise(ae=>{b.onicecandidate=ie=>{!ie.candidate&&b.localDescription!=null&&ae(b.localDescription.sdp)}})},w=async S=>{const b=await y();b.onconnectionstatechange=()=>{b.connectionState==="connected"&&(t.info("connected to host"),S())}},_=He(n,f,S=>{const b=m.clone();P(b);for(const E of b.getTracks())S.addTrack(E,b);re(S,s,r,t,e)},t,o);return{createAnswer:C,setOnConnect:w,close:async()=>(await y()).close(),signalService:_,createHostPeer:x,changeVolume:i}},at=Te("guestName","\u306A\u306A\u3057\u3055\u3093"),H=q([]),it=({setService:e,playAudio:t})=>{const n=A(),{color:o}=F(),s=k(oe),[r,a]=ne(at),i=k(H),m=ye();return c("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"}),children:g("div",{css:u({width:"100%",padding:"2rem"}),children:[c("div",{css:u({display:"flex",width:"100%",justifyContent:"center",marginBottom:"3rem"}),children:c("input",{type:"text",css:u({outline:"none",border:"none",fontSize:"1rem",padding:"0.25rem 0.5rem",height:"3rem",width:"14rem"}),onChange:d=>{a(d.target.value)},value:r})}),c("div",{css:u({display:"flex",justifyContent:"center",alignItems:"center",width:"100%"}),children:c("button",{type:"button",css:u({padding:"0.5rem 1rem",outline:"none",border:"none",background:o.primary.main,color:o.primary.text,fontSize:"1.5rem",width:"14rem"}),onClick:async()=>{const d=await ct(t,n,r,m);e(d),s(!0),i(f=>{f.push({stage:1})})},children:"\u63A5\u7D9A\u958B\u59CB"})})]})})},ut=()=>{const[e,t]=l.exports.useState(void 0),n=k(H),o=A(),s=l.exports.useCallback(async a=>{o.info("offer1 received:"),t(a.binaryData)},[]),r=l.exports.useCallback(async()=>{e!=null&&n(a=>{a.push({stage:2,halfOffer:e})})},[e]);return g(B,{title:"1.\u30AA\u30D5\u30A1\u30FC\u53D7\u4FE1(\u524D\u534A)",children:[e==null&&c(ee,{onResult:s}),e&&c(j,{nextTitle:"\u6B21\u3078",onNext:r})]})},dt=({stage:e,service:t})=>{const[n,o]=l.exports.useState(void 0),s=k(H),r=A(),a=l.exports.useCallback(async m=>{r.info("offer2 received:");const d=Se(new Uint8Array([...e.halfOffer,...m.binaryData]));if(console.log(d),o(d),d!=null){o(d),await t.createHostPeer();const f=await t.createAnswer(d);s(v=>{console.log("answer sdp:",f),v.push({stage:3,sdp:f})})}},[]),i=l.exports.useCallback(()=>{o(void 0),s(m=>{m.pop()})},[]);return g(B,{title:"2.\u30AA\u30D5\u30A1\u30FC\u53D7\u4FE1(\u5F8C\u534A)",children:[n==null&&c(ee,{onResult:a}),c(j,{backTitle:"\u623B\u308B",onBack:i})]})},lt=({stage:e,service:t})=>{const n=k(H),[o,s]=l.exports.useState(1),r=A(),a=o===1?"3.\u30A2\u30F3\u30B5\u30FC(\u524D\u534A)":"3.\u30A2\u30F3\u30B5\u30FC(\u5F8C\u534A)",i=Ae(e.sdp,o,r,[e],[e,o]),m=l.exports.useCallback(()=>{o===1&&s(2)},[]),d=l.exports.useCallback(()=>{if(o===2){s(1);return}n(f=>{f.pop(),f.pop()})},[]);return l.exports.useLayoutEffect(()=>{t.setOnConnect(()=>{n(f=>{f.push({stage:4})})})},[]),g(B,{title:a,children:[i&&c("div",{css:u({display:"flex",justifyContent:"center",width:"100%",marginBottom:"1rem"}),children:c(ke,{src:i,cacheKey:`guest-answer-${o}`})}),c("p",{css:u({width:"100%",fontFamily:"monospace",paddingLeft:"1rem"}),children:c("span",{children:`\u30DB\u30B9\u30C8\u306BQR\u30B3\u30FC\u30C9\u3092${o===2?"\u3082\u3046\u4E00\u5EA6":""}\u63D0\u793A\u3057\u3066\u304F\u3060\u3055\u3044\u3002`})}),c(j,{backTitle:"\u623B\u308B",nextTitle:o===1?"\u6B21\u3078":void 0,onNext:m,onBack:d})]})},ft=()=>{const e=k(H);return console.log("here"),l.exports.useEffect(()=>{e(()=>[{stage:5}])},[]),c(B,{title:"4. \u63A5\u7D9A\u4E2D",children:c("p",{children:"\u63A5\u7D9A\u4E2D\u3067\u3059..."})})},mt=({service:e})=>{const t=e.signalService.peers;return we(),c(B,{title:"\u63A5\u7D9A\u4E00\u89A7",children:g("ol",{children:[c("li",{children:"\u30DB\u30B9\u30C8"}),Array.from(t.values()).map(n=>c("li",{children:`${n.id.slice(0,6)} ${n.name}`},n.id))]})})},pt=({service:e})=>{const t=T(H),n=t[t.length-1];return n==null?null:n.stage===1?c(ut,{}):n.stage===2?c(dt,{stage:n,service:e}):n.stage===3?c(lt,{stage:n,service:e}):n.stage===4?c(ft,{}):n.stage===5?c(mt,{service:e}):c(L,{})},gt=()=>{const e=l.exports.useRef(null),t=A(),[n,o]=l.exports.useState(void 0),s=l.exports.useCallback(async r=>{if(e.current==null){t.warn("ignore playAudio() since no audio element found.");return}e.current.srcObject=r,await e.current.play()},[]);return g("main",{css:u({width:"100%",height:"100%",maxWidth:1200}),children:[n==null&&c(it,{setService:o,playAudio:s}),n&&c(pt,{service:n}),c(be,{audioRef:e}),n&&c(De,{service:n})]})},ht=()=>{const[e,t]=ne(Y),n=T(oe),o=A(),{color:s}=F(),r=e==="host"?"\u30DB\u30B9\u30C8":"\u30B2\u30B9\u30C8",a=e==="host"?"\u30B2\u30B9\u30C8":"\u30DB\u30B9\u30C8";return c("button",{className:J({started:n}),css:u({width:"9rem",border:"none",outline:"none",padding:"0.125rem 0.5rem",background:`linear-gradient(135deg, ${s.primary.main} 50%, ${s.secondary.main} 50%)`,color:s.primary.text,"&.started":{background:s.background.dark,color:s.text}}),type:"button",onClick:()=>{if(n){o.warn("\u30BB\u30C3\u30B7\u30E7\u30F3\u304C\u958B\u59CB\u3055\u308C\u3066\u3044\u307E\u3059\u3002\u30E2\u30FC\u30C9\u3092\u5909\u66F4\u3067\u304D\u307E\u305B\u3093\u3002");return}t(i=>i==="host"?"guest":"host")},disabled:n,children:n?c("span",{children:r}):g(L,{children:[c("span",{css:u({fontWeight:"bolder"}),children:`[${r}]`})," \u21D2 ",c("span",{children:a})]})})},yt=()=>{const{color:e}=F(),[t,n]=l.exports.useState("");return l.exports.useEffect(()=>{const o=Array.from(document.getElementsByTagName("script"));for(const s of o){const r=/index\.([^.]+)\.js$/.exec(s.src);if(r){n(r[1]);break}}},[]),g("header",{css:u({display:"flex",justifyContent:"space-between",alignItems:"center",height:"100%",paddingLeft:"0.5rem",paddingRight:"1rem",background:e.background.light}),children:[g("span",{children:["QR WebRTC",t?` -${t}`:""]}),c(ht,{})]})},wt=Q.memo(function({item:t}){const{timestamp:n,level:o,message:s}=t,a=`${[n.getHours(),n.getMinutes(),n.getSeconds()].map(i=>i.toString(10).padStart(2,"0")).join(":")} [${o.toUpperCase()}] ${s}`;return c("li",{className:o,css:u({fontFamily:"monospace","&.info":{color:"#bdbdbd"},"&.warn":{color:"#ffa726"},"&.error":{color:"#ef5350"},"&.success":{color:"#29b6f6"}}),children:a})}),bt=Q.memo(function({items:t}){return c("ul",{css:u({height:"100%",paddingLeft:"0.5rem"}),children:t.map(n=>c(wt,{item:n},n.id))})}),_e=({value:e,setValue:t,onMuteClick:n,icon:o})=>g("div",{css:u({display:"block"}),children:[c("input",{type:"range",step:.01,min:0,max:1,value:e,onChange:s=>{t(s.currentTarget.value)}}),c("button",{css:u({outline:"none",border:"none",background:"transparent"}),type:"button",onClick:n,children:o})]}),vt=()=>{const[e,t]=ne(se);return g("div",{css:u({display:"flex",alignItems:"center",justifyContent:"space-around",width:"100%"}),children:[c("div",{css:u({display:"block"}),children:c(_e,{value:e.mic.volume,onMuteClick:()=>{t(n=>{n.mic.muted=!n.mic.muted})},setValue:n=>{t(o=>{o.mic.volume=Number(n)})},icon:e.mic.muted?"\u{1F515}":"\u{1F3A4}"})}),c("div",{css:u({display:"block"}),children:c(_e,{value:e.speaker.volume,onMuteClick:()=>{t(n=>{n.speaker.muted=!n.speaker.muted})},setValue:n=>{t(o=>{o.speaker.volume=Number(n)})},icon:e.speaker.muted?"\u{1F507}":"\u{1F50A}"})})]})},Ct=()=>{const[e,t]=l.exports.useState(!1),{color:n}=F(),o=Ne(),s=o.length>0&&o[o.length-1].level==="error";return l.exports.useEffect(()=>{s&&t(!0)},[s]),g("footer",{className:J({open:e}),css:u({display:"grid",height:"3.5rem",gridTemplateRows:"2rem 1.5rem 1fr",overflow:"hidden",transition:"all 0.5s","&.open":{height:"12rem"},background:n.background.dark,color:n.text}),children:[c("div",{css:u({display:"flex",alignItems:"center",borderBottom:`1px solid ${n.primary.dark}`,width:"100%"}),children:c(vt,{})}),g("button",{type:"button",className:J({error:s}),css:u({display:"flex",justifyContent:"right",alignItems:"center",width:"100%",height:"100%",paddingRight:"1rem",border:"none",outline:"none",background:n.background.dark,color:n.text,"&.error":{background:"#b61827"}}),onClick:()=>t(r=>!r),children:[c("span",{css:u({marginRight:"0.75rem"}),children:"\u30ED\u30B0"}),c("span",{className:J({open:e}),css:u({display:"inline-block",height:"0.75rem",width:"0.75rem",borderLeft:"0.375rem solid transparent",borderBottom:"0.75rem solid white",borderRight:"0.375rem solid transparent",transition:"all 0.5s","&.open":{transform:"rotate(-180deg)"}})})]}),c("div",{css:u({height:"100%",overflowY:"scroll",borderTop:`1px solid ${n.primary.dark}`,scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"}}),children:c(bt,{items:o})})]})},St=({children:e})=>{const{color:t}=F();return g(L,{children:[g("div",{css:u({display:"grid",width:"100%",height:"100%",gridTemplateRows:"2.5rem 1fr auto"}),children:[c("div",{css:u({height:"100%"}),children:c(yt,{})}),c("div",{css:u({height:"100%",display:"flex",justifyContent:"center"}),children:e}),c("div",{css:u({height:"100%"}),children:c(Ct,{})})]}),c(Fe,{styles:u({"html, body, #root":{height:"100%"},"*":{boxSizing:"border-box",margin:0,padding:0},"ul, ol":{margin:0,padding:0,listStyleType:"none"},body:{background:t.background.main,color:t.text,margin:0,padding:0}})})]})},xt=()=>{const e=T(Y),t=k(Y);return l.exports.useLayoutEffect(()=>{xe().catch(s=>{console.error(s)});const o=new URLSearchParams(window.location.hash.substring(1)).get("as")||"host";t(o==="host"?"host":"guest")},[]),$(St,{children:e==="host"?$(rt,{}):$(gt,{})})},kt=({children:e})=>c(Pe,{children:e});function At(e={}){const{immediate:t=!1,onNeedRefresh:n,onOfflineReady:o,onRegistered:s,onRegisterError:r}=e;let a,i;const m=async(d=!0)=>{d&&(a==null||a.addEventListener("controlling",f=>{f.isUpdate&&window.location.reload()})),i&&i.waiting&&await Me(i.waiting,{type:"SKIP_WAITING"})};if("serviceWorker"in navigator){a=new Ie("/qr-webrtc-dev/sw.js",{scope:"/qr-webrtc-dev/"}),a.addEventListener("activated",d=>{d.isUpdate||o==null||o()});{const d=()=>{n==null||n()};a.addEventListener("waiting",d),a.addEventListener("externalwaiting",d)}a.register({immediate:t}).then(d=>{i=d,s==null||s(d)}).catch(d=>{r==null||r(d)})}return m}At();Le.render($(Q.StrictMode,{children:$(kt,{children:$(xt,{})})}),document.getElementById("root"));
